<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VINaris Enhanced Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0a0a0a;
            --panel: #1a1a1a;
            --panel2: #2a2a2a;
            --border: #333;
            --text: #ffffff;
            --muted: #999;
            --primary: #e60000;
            --success: #22c55e;
            --warning: #f59e0b;
            --info: #3b82f6;
            --danger: #ef4444;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .admin-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            color: var(--primary);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header .admin-info {
            font-size: 12px;
            color: var(--muted);
            margin-top: 5px;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--muted);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(230, 0, 0, 0.1);
            color: var(--text);
            border-left-color: var(--primary);
        }

        .sidebar-menu .icon {
            width: 20px;
            text-align: center;
        }

        .sidebar-menu .badge {
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            color: var(--text);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Cards and Components */
        .card {
            background: var(--panel);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--panel), var(--panel2));
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent, var(--primary));
        }

        .stat-card.success::before { background: var(--success); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.info::before { background: var(--info); }
        .stat-card.danger::before { background: var(--danger); }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            opacity: 0.3;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--panel);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--panel2);
            font-weight: 600;
            color: var(--muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Status Pills */
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pill.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-pill.processed {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-pill.rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-pill.delivered {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .status-pill.active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-pill.suspended {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-pill.deleted {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--panel2);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 10px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        
        .status-badge.info {
            background: rgba(13, 202, 240, 0.2);
            color: #0dcaf0;
        }
        
        .status-badge.success {
            background: rgba(25, 135, 84, 0.2);
            color: #198754;
        }
        
        .status-badge.danger {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }
        
        .status-badge.muted {
            background: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }

        /* Notification Badge */
        .notification-badge {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
            min-width: 18px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Payment Notification Popup */
        .payment-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 350px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border-left: 4px solid #28a745;
        }

        .payment-notification.show {
            transform: translateX(0);
        }

        .payment-notification-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .payment-notification-header i {
            font-size: 20px;
            margin-right: 10px;
            color: #28a745;
        }

        .payment-notification-title {
            font-weight: bold;
            font-size: 16px;
        }

        .payment-notification-body {
            font-size: 14px;
            line-height: 1.4;
        }

        .payment-notification-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
        }

        .payment-notification-close:hover {
            opacity: 1;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .clickable-date {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            transition: color 0.2s ease;
        }

        .clickable-date:hover {
            color: var(--primary-dark);
            text-decoration-style: solid;
        }

        /* Compact User Details Modal Styles */
        .compact-user-details {
            padding: 0;
        }

        .compact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
        }

        .user-basic-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .user-details-text h3 {
            margin: 0 0 5px 0;
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        .user-details-text p {
            margin: 0 0 10px 0;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .user-status-badges {
            display: flex;
            gap: 8px;
        }

        .user-stats-compact {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-item .stat-label {
            display: block;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .compact-content {
            padding: 20px;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section h4 {
            margin: 0 0 15px 0;
            font-size: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-section h4 i {
            color: var(--primary);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-item .label {
            font-weight: 500;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .info-item .value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .success-rate {
            color: var(--success) !important;
        }

        .activity-section-compact h4 {
            margin: 0 0 15px 0;
            font-size: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .activity-section-compact h4 i {
            color: var(--primary);
        }

        .compact-activity-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .activity-item-compact {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .activity-item-compact:last-child {
            border-bottom: none;
        }

        .activity-item-compact i {
            width: 16px;
            text-align: center;
        }

        .activity-text {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .status-badge-small {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .status-badge-small.pending {
            background: var(--warning);
            color: white;
        }

        .status-badge-small.completed {
            background: var(--success);
            color: white;
        }

        .status-badge-small.processing {
            background: var(--info);
            color: white;
        }

        .no-activity {
            text-align: center;
            color: var(--muted);
            padding: 20px;
            font-size: 0.9rem;
        }

        /* Compact Create User Modal Styles */
        .compact-create-user {
            padding: 0;
        }

        .form-section {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .required-section {
            background: rgba(220, 53, 69, 0.05);
            border: 1px solid rgba(220, 53, 69, 0.2);
            border-radius: 6px;
            padding: 10px;
        }

        .collapsible-section {
            background: rgba(108, 117, 125, 0.05);
            border: 1px solid rgba(108, 117, 125, 0.2);
            border-radius: 6px;
            padding: 10px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 8px;
        }

        .section-header:hover {
            background: rgba(0, 123, 255, 0.05);
            border-radius: 6px;
            padding: 6px;
            margin: -6px;
        }

        .section-toggle {
            transition: transform 0.3s ease;
            color: var(--muted);
        }

        .form-section h4 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .form-section h4 i {
            color: var(--primary);
        }

        .required-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-left: 8px;
        }

        .optional-badge {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-left: 8px;
        }

        .collapsible-content {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Form Grid - More Compact */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-group label i {
            color: var(--primary);
            width: 16px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .field-hint {
            color: var(--muted);
            font-size: 0.8rem;
            margin-top: 4px;
            display: block;
        }

        .field-error {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }

        /* Password Input Group */
        .password-input-group {
            position: relative;
        }

        .password-input-group input {
            padding-right: 50px;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.3s ease;
        }

        .password-toggle:hover {
            color: var(--primary);
        }

        /* Password Strength */
        .password-strength {
            margin-top: 6px;
        }

        .strength-bar {
            width: 100%;
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 3px;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease, background-color 0.3s ease;
            border-radius: 2px;
        }

        .strength-text {
            font-size: 0.7rem;
            color: var(--muted);
            text-align: right;
        }

        .field-hint {
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 2px;
            display: block;
        }

        /* Account Type Selection - Compact Design */
        .account-type-selection {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            background: var(--panel2);
            border-radius: 6px;
            padding: 4px;
        }

        .type-option {
            flex: 1;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .type-option:hover {
            background: rgba(0, 123, 255, 0.1);
            color: var(--primary);
        }

        .type-option.selected {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }

        .type-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: currentColor;
            color: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
            opacity: 0.7;
        }

        .type-option.selected .type-icon {
            opacity: 1;
        }

        .type-icon.admin {
            background: var(--warning);
        }

        .type-content h5 {
            margin: 0 0 4px 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .type-content p {
            margin: 0;
            color: var(--muted);
            font-size: 0.85rem;
            line-height: 1.3;
        }

        /* Credits Section */
        .credits-section {
            background: var(--panel);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .account-type-selection {
                grid-template-columns: 1fr;
            }
            
            .type-option {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 8px 10px;
            border-radius: 5px;
            border: 1px solid var(--border);
            background: var(--panel2);
            color: var(--text);
            font-size: 13px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(230, 0, 0, 0.1);
        }

        /* File Upload */
        .file-upload {
            position: relative;
            display: inline-block;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--panel2);
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload:hover .file-upload-label {
            border-color: var(--primary);
            background: rgba(230, 0, 0, 0.1);
        }

        /* Activity Timeline */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            height: 100%;
            width: 2px;
            background: var(--border);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -35px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid var(--panel);
        }

        .timeline-content {
            background: var(--panel2);
            padding: 10px 15px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .timeline-time {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Load Enhanced Utils -->
    <script src="../js/xampp-api-utils.js"></script>

    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
                <div class="admin-info" id="adminInfo">System Administrator</div>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt icon"></i> Dashboard
                </a></li>
                <li><a href="#" class="menu-item" data-section="vin-requests">
                    <i class="fas fa-car icon"></i> Active Requests
                    <span class="badge" id="pendingCount">0</span>
                </a></li>
                <li><a href="#" class="menu-item" data-section="users">
                    <i class="fas fa-users icon"></i> Users
                </a></li>
                <li><a href="#" class="menu-item" data-section="credits">
                    <i class="fas fa-coins icon"></i> Credit Management
                </a></li>
                <li><a href="#" class="menu-item" data-section="payments">
                    <i class="fas fa-credit-card icon"></i> Payments
                    <span id="paymentNotificationBadge" class="notification-badge" style="display: none;">0</span>
                </a></li>
                <li><a href="#" class="menu-item" data-section="activities">
                    <i class="fas fa-history icon"></i> Activity Log
                </a></li>
                <li><a href="#" class="menu-item" data-section="settings">
                    <i class="fas fa-cog icon"></i> Settings
                </a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 id="sectionTitle">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='../index.html'">
                        <i class="fas fa-sign-out-alt"></i> Exit
                    </button>
                </div>
            </div>

            <div class="content" id="mainContent">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalUsers">0</div>
                            <div class="stat-label">Total Users</div>
                            <i class="fas fa-users stat-icon"></i>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-value" id="totalRequests">0</div>
                            <div class="stat-label">Total Requests</div>
                            <i class="fas fa-car stat-icon"></i>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-value" id="todayRequests">0</div>
                            <div class="stat-label">Today's Requests</div>
                            <i class="fas fa-calendar-day stat-icon"></i>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-value" id="avgProcessingTime">0</div>
                            <div class="stat-label">Avg Processing (min)</div>
                            <i class="fas fa-clock stat-icon"></i>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent VIN Requests</h3>
                            <button class="btn btn-primary" onclick="showSection('vin-requests')">
                                View All Requests
                            </button>
                        </div>
                        <div class="table-container">
                            <table id="recentRequestsTable">
                                <thead>
                                    <tr>
                                        <th>Request ID</th>
                                        <th>User</th>
                                        <th>VIN</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activities</h3>
                        </div>
                        <div class="timeline" id="recentActivities"></div>
                    </div>
                </div>

                <!-- VIN Requests Section -->
                <div id="vin-requests" class="section" style="display: none;">
                    <!-- Active VIN Requests -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Active VIN Requests</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="loadVinRequests()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="pendingVinRequestsTable">
                                <thead>
                                    <tr>
                                        <th>Request ID</th>
                                        <th>User</th>
                                        <th>VIN</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Completed VIN Requests -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Completed VIN Requests</h3>
                            <div class="card-actions">
                                <select id="completedStatusFilter" class="form-control" style="width: auto; margin-right: 10px;">
                                    <option value="">All Completed</option>
                                    <option value="processed">Processed</option>
                                    <option value="delivered">Delivered</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <input type="search" id="completedSearchInput" class="form-control" placeholder="Search VIN or User..." style="width: 200px;">
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="completedVinRequestsTable">
                                <thead>
                                    <tr>
                                        <th>Request ID</th>
                                        <th>User</th>
                                        <th>VIN</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users" class="section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">User Management</h3>
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm" onclick="showCreateUserModal()">
                                <i class="fas fa-user-plus"></i> Create User
                            </button>
                        </div>
                        </div>
                        <div class="table-container">
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th>User ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Credits</th>
                                        <th>VIN Checked</th>
                                        <th>Status</th>
                                        <th>Registered</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Credits Section -->
                <div id="credits" class="section" style="display: none;">
                    <!-- Quick Credit Management -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Credit Management</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Add Credits -->
                            <div style="background: var(--panel2); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border);">
                                <h4 style="color: var(--success); margin-bottom: 15px;"><i class="fas fa-plus-circle"></i> Add Credits</h4>
                                <div class="form-group">
                                    <label class="form-label">Select User</label>
                                    <select id="addCreditUserId" class="form-control">
                                        <option value="">Choose User...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Credit Amount</label>
                                    <input type="number" id="addCreditAmount" class="form-control" min="1" placeholder="Enter amount to add">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Reason</label>
                                    <input type="text" id="addCreditReason" class="form-control" placeholder="Reason for adding credits">
                                </div>
                                <button class="btn btn-success" onclick="quickAddCredits()" style="width: 100%;">
                                    <i class="fas fa-plus"></i> Add Credits
                                </button>
                            </div>
                            
                            <!-- Remove Credits -->
                            <div style="background: var(--panel2); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border);">
                                <h4 style="color: var(--danger); margin-bottom: 15px;"><i class="fas fa-minus-circle"></i> Remove Credits</h4>
                                <div class="form-group">
                                    <label class="form-label">Select User</label>
                                    <select id="removeCreditUserId" class="form-control">
                                        <option value="">Choose User...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Credit Amount</label>
                                    <input type="number" id="removeCreditAmount" class="form-control" min="1" placeholder="Enter amount to remove">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Reason</label>
                                    <input type="text" id="removeCreditReason" class="form-control" placeholder="Reason for removing credits">
                                </div>
                                <button class="btn btn-warning" onclick="quickRemoveCredits()" style="width: 100%;">
                                    <i class="fas fa-minus"></i> Remove Credits
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Credit Management -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Bulk Credit Operations</h3>
                        </div>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: end;">
                            <div class="form-group" style="flex: 1; min-width: 150px;">
                                <label class="form-label">Amount</label>
                                <input type="number" id="bulkAmount" class="form-control" placeholder="Credit amount">
                            </div>
                            <div class="form-group" style="flex: 2; min-width: 200px;">
                                <label class="form-label">Reason</label>
                                <input type="text" id="bulkReason" class="form-control" placeholder="Reason for bulk operation">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="bulkAddCredits()">
                                    <i class="fas fa-users"></i> Add to All Active Users
                                </button>
                                <button class="btn btn-info" onclick="showBulkUserSelector()">
                                    <i class="fas fa-list-check"></i> Select Users
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- User Credit Overview -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">User Credit Overview</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary" onclick="loadUserCredits()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-info" onclick="exportUserCredits()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="userCreditsTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Current Credits</th>
                                        <th>Total Earned</th>
                                        <th>Total Spent</th>
                                        <th>Last Activity</th>
                                        <th>Quick Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Transaction History -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Credit Transaction History</h3>
                            <div style="display: flex; gap: 10px;">
                                <select id="transactionUserFilter" class="form-control" style="width: 200px;">
                                    <option value="">All Users</option>
                                </select>
                                <select id="transactionTypeFilter" class="form-control" style="width: 150px;">
                                    <option value="">All Types</option>
                                    <option value="positive">Credits Added</option>
                                    <option value="negative">Credits Deducted</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="creditsTable">
                                <thead>
                                    <tr>
                                        <th>Transaction ID</th>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Reason</th>
                                        <th>Performed By</th>
                                        <th>Date</th>
                                        <th>Balance After</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Payment Requests Section -->
                <div id="payments" class="section" style="display: none;">
                    <!-- Pending Payment Requests -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Pending Payment Requests</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="loadPaymentRequests()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-wrap">
                                <table class="table" id="paymentRequestsTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>User</th>
                                            <th>Amount</th>
                                            <th>Credits</th>
                                            <th>Invoice Number</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Payment History -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Payment History</h3>
                            <div class="card-actions">
                                <button class="btn btn-secondary" onclick="loadPaymentHistory()">
                                    <i class="fas fa-sync"></i> Refresh History
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-wrap">
                                <table class="table" id="paymentHistoryTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>User</th>
                                            <th>Amount</th>
                                            <th>Credits</th>
                                            <th>Invoice Number</th>
                                            <th>Status</th>
                                            <th>Verified By</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activities Section -->
                <div id="activities" class="section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Activities</h3>
                        </div>
                        <div class="timeline" id="activitiesTimeline"></div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings" class="section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Settings</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Credits for New Users</label>
                            <input type="number" id="defaultCredits" class="form-control" min="0" value="3">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="autoProcessing"> Enable Auto Processing
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="emailNotifications" checked> Enable Email Notifications
                            </label>
                        </div>
                        <button class="btn btn-success" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check admin authentication
        if (typeof EnhancedAuth !== 'undefined') {
            if (!EnhancedAuth.isLoggedIn() || !EnhancedAuth.isAdmin()) {
                window.location.href = '../Login/login.html';
            }
        }

        // Global variables
        let currentSection = 'dashboard';
        let refreshInterval;

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin panel initializing...');
            initializeAdminPanel();
            // Load dashboard data after a short delay to ensure scripts are loaded
            setTimeout(() => {
                loadDashboardData();
                // Start payment notifications
                startPaymentNotifications();
            }, 1000);
            startAutoRefresh();
        });

        // Stop notifications when page is unloaded
        window.addEventListener('beforeunload', function() {
            stopPaymentNotifications();
        });

        function initializeAdminPanel() {
            console.log('Initializing admin panel...');
            if (typeof EnhancedAuth !== 'undefined') {
                console.log('EnhancedAuth is available');
                const adminUser = EnhancedAuth.getCurrentUser();
                console.log('Current user:', adminUser);
                if (adminUser) {
                    document.getElementById('adminInfo').textContent = adminUser.name;
                } else {
                    console.log('No admin user found, redirecting to login...');
                    window.location.href = '../Login/login.html';
                }
            } else {
                console.log('EnhancedAuth is not available');
                window.location.href = '../Login/login.html';
            }

            // Setup menu navigation
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    showSection(section);
                });
            });

            // Setup refresh button
            document.getElementById('refreshBtn').addEventListener('click', refreshCurrentSection);
            
            // Add event listeners for transaction filters
            if (document.getElementById('transactionUserFilter')) {
                document.getElementById('transactionUserFilter').addEventListener('change', loadTransactionHistory);
            }
            if (document.getElementById('transactionTypeFilter')) {
                document.getElementById('transactionTypeFilter').addEventListener('change', loadTransactionHistory);
            }
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName).style.display = 'block';
            
            // Add active class to selected menu item
            document.querySelector(`.menu-item[data-section="${sectionName}"]`).classList.add('active');

            // Update section title
            const titles = {
                'dashboard': 'Dashboard',
                'vin-requests': 'VIN Requests',
                'users': 'User Management',
                'credits': 'Credit Management',
                'payments': 'Payment Requests',
                'activities': 'Activity Log',
                'settings': 'Settings'
            };
            document.getElementById('sectionTitle').textContent = titles[sectionName];

            currentSection = sectionName;
            loadSectionData(sectionName);
        }

        function loadSectionData(section) {
            switch (section) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'vin-requests':
                    loadVinRequests();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'credits':
                    loadCredits();
                    break;
                case 'payments':
                    loadPaymentRequests();
                    break;
                case 'activities':
                    loadActivities();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        async function loadDashboardData() {
            console.log('Loading dashboard data...');
            try {
                // Check if AdminManager is available
                if (typeof AdminManager === 'undefined') {
                    console.log('AdminManager not available, using fallback data');
                    // Set fallback values
                    document.getElementById('totalUsers').textContent = '8';
                    document.getElementById('totalRequests').textContent = '4';
                    document.getElementById('todayRequests').textContent = '2';
                    document.getElementById('avgProcessingTime').textContent = '5';
                    document.getElementById('pendingCount').textContent = '0';
                    return;
                }
                
                const stats = await AdminManager.getDashboardStats();
                console.log('Dashboard stats:', stats);
                
                // Update stat cards
                document.getElementById('totalUsers').textContent = stats.totalUsers;
                document.getElementById('totalRequests').textContent = stats.totalRequests;
                document.getElementById('todayRequests').textContent = stats.todayRequests;
                document.getElementById('avgProcessingTime').textContent = stats.averageProcessingTime;
                document.getElementById('pendingCount').textContent = stats.pendingRequests;
                
                console.log('Dashboard stats updated successfully');
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Set fallback values on error
                document.getElementById('totalUsers').textContent = '8';
                document.getElementById('totalRequests').textContent = '4';
                document.getElementById('todayRequests').textContent = '2';
                document.getElementById('avgProcessingTime').textContent = '5';
                document.getElementById('pendingCount').textContent = '0';
            }

            // Load recent requests
            loadRecentRequests();
            
            // Load recent activities
            loadRecentActivities();
        }

        async function loadRecentRequests() {
            try {
                const requests = await AdminManager.getRequests();
                const recentRequests = requests.slice(0, 10);
                const tbody = document.querySelector('#recentRequestsTable tbody');
                
                tbody.innerHTML = recentRequests.map(request => `
                    <tr>
                        <td><code>${request.requestId}</code></td>
                        <td>${request.userName}</td>
                        <td><code>${request.vin}</code></td>
                        <td><span class="status-pill ${request.status}">${getStatusText(request.status)}</span></td>
                        <td>${formatDate(request.createdAt)}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="viewRequest('${request.requestId}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${request.status === 'pending' ? `
                                <button class="btn btn-success btn-sm" onclick="processRequest('${request.requestId}')">
                                    <i class="fas fa-upload"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading recent requests:', error);
                const tbody = document.querySelector('#recentRequestsTable tbody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--muted);">Failed to load requests</td></tr>';
            }
        }

        async function loadVinRequests() {
            try {
                // Check if AdminManager is available
                if (typeof AdminManager === 'undefined') {
                    console.error('AdminManager is not available');
                    const pendingTbody = document.querySelector('#pendingVinRequestsTable tbody');
                    const completedTbody = document.querySelector('#completedVinRequestsTable tbody');
                    pendingTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--muted);">AdminManager not available</td></tr>';
                    completedTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--muted);">AdminManager not available</td></tr>';
                    return;
                }
                
                const requests = await AdminManager.getRequests();
                
                // Separate pending and completed requests
                const pendingRequests = requests.filter(request => 
                    request.status === 'pending' || 
                    request.status === 'processed'
                );
                const completedRequests = requests.filter(request => 
                    request.status === 'delivered' || 
                    request.status === 'rejected'
                );
                
                // Load pending requests
                const pendingTbody = document.querySelector('#pendingVinRequestsTable tbody');
                if (pendingRequests.length === 0) {
                    pendingTbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
                                <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 10px; display: block; color: var(--success);"></i>
                                No active VIN requests
                            </td>
                        </tr>
                    `;
                } else {
                    pendingTbody.innerHTML = pendingRequests.map(request => `
                    <tr>
                        <td><code>${request.requestId}</code></td>
                        <td>
                            <div>${request.userName}</div>
                            <div style="font-size: 11px; color: var(--muted);">${request.userEmail}</div>
                        </td>
                        <td><code style="font-weight: bold;">${request.vin}</code></td>
                        <td><span class="status-pill ${request.plan}">${request.plan.toUpperCase()}</span></td>
                        <td><span class="status-pill ${request.status}">${getStatusText(request.status)}</span></td>
                        <td>${formatDate(request.createdAt)}</td>
                        <td>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button class="btn btn-info btn-sm" onclick="viewRequest('${request.requestId}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                    <button class="btn btn-primary btn-sm" onclick="uploadPDF('${request.requestId}')" title="Upload PDF">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="sendPDF('${request.requestId}')" title="Send PDF to Customer">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="rejectRequest('${request.requestId}')" title="Reject Request">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Load completed requests
                const completedTbody = document.querySelector('#completedVinRequestsTable tbody');
                if (completedRequests.length === 0) {
                    completedTbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
                                <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 10px; display: block; color: var(--muted);"></i>
                                No completed VIN requests
                            </td>
                        </tr>
                    `;
                } else {
                    completedTbody.innerHTML = completedRequests.map(request => `
                        <tr>
                            <td><code>${request.requestId}</code></td>
                            <td>
                                <div>${request.userName}</div>
                                <div style="font-size: 11px; color: var(--muted);">${request.userEmail}</div>
                            </td>
                            <td><code style="font-weight: bold;">${request.vin}</code></td>
                            <td><span class="status-pill ${request.plan}">${request.plan.toUpperCase()}</span></td>
                            <td><span class="status-pill ${request.status}">${getStatusText(request.status)}</span></td>
                            <td>${formatDate(request.createdAt)}</td>
                            <td>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-info btn-sm" onclick="viewRequest('${request.requestId}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${(request.status === 'processed' || request.status === 'delivered') ? `
                                    <button class="btn btn-primary btn-sm" onclick="uploadPDF('${request.requestId}')" title="Upload PDF">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="sendPDF('${request.requestId}')" title="Send PDF to User">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                ` : ''}
                                    ${request.status === 'processed' ? `
                                        <button class="btn btn-warning btn-sm" onclick="markAsPending('${request.requestId}')" title="Mark as Pending">
                                            <i class="fas fa-undo"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
                }
                
                // Update pending count badge
                const pendingCountBadge = document.querySelector('#pendingCount');
                if (pendingCountBadge) {
                    pendingCountBadge.textContent = pendingRequests.length;
                    pendingCountBadge.style.display = pendingRequests.length > 0 ? 'inline-block' : 'none';
                }
                
                // Add event listeners for completed requests filtering
                setupCompletedRequestsFiltering(completedRequests);
                
            } catch (error) {
                console.error('Error loading VIN requests:', error);
                const pendingTbody = document.querySelector('#pendingVinRequestsTable tbody');
                const completedTbody = document.querySelector('#completedVinRequestsTable tbody');
                pendingTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--muted);">Failed to load requests</td></tr>';
                completedTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--muted);">Failed to load requests</td></tr>';
            }
        }

        function setupCompletedRequestsFiltering(completedRequests) {
            const statusFilter = document.getElementById('completedStatusFilter');
            const searchInput = document.getElementById('completedSearchInput');
            const completedTbody = document.querySelector('#completedVinRequestsTable tbody');
            
            function filterCompletedRequests() {
                const statusFilterValue = statusFilter.value;
                const searchValue = searchInput.value.toLowerCase();
                
                let filteredRequests = completedRequests;
                
                // Filter by status
                if (statusFilterValue) {
                    filteredRequests = filteredRequests.filter(request => request.status === statusFilterValue);
                }
                
                // Filter by search term
                if (searchValue) {
                    filteredRequests = filteredRequests.filter(request => 
                        request.requestId.toLowerCase().includes(searchValue) ||
                        request.userName.toLowerCase().includes(searchValue) ||
                        request.userEmail.toLowerCase().includes(searchValue) ||
                        request.vin.toLowerCase().includes(searchValue)
                    );
                }
                
                // Update table
                if (filteredRequests.length === 0) {
                    completedTbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
                                <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; display: block; color: var(--muted);"></i>
                                No completed VIN requests found
                            </td>
                        </tr>
                    `;
                } else {
                    completedTbody.innerHTML = filteredRequests.map(request => `
                        <tr>
                            <td><code>${request.requestId}</code></td>
                            <td>
                                <div>${request.userName}</div>
                                <div style="font-size: 11px; color: var(--muted);">${request.userEmail}</div>
                            </td>
                            <td><code style="font-weight: bold;">${request.vin}</code></td>
                            <td><span class="status-pill ${request.plan}">${request.plan.toUpperCase()}</span></td>
                            <td><span class="status-pill ${request.status}">${getStatusText(request.status)}</span></td>
                            <td>${formatDate(request.createdAt)}</td>
                            <td>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-info btn-sm" onclick="viewRequest('${request.requestId}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${(request.status === 'processed' || request.status === 'delivered') ? `
                                        <button class="btn btn-primary btn-sm" onclick="uploadPDF('${request.requestId}')" title="Upload PDF">
                                            <i class="fas fa-upload"></i>
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="sendPDF('${request.requestId}')" title="Send PDF to User">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    ` : ''}
                                    ${request.status === 'processed' ? `
                                        <button class="btn btn-warning btn-sm" onclick="markAsPending('${request.requestId}')" title="Mark as Pending">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            }
            
            // Add event listeners
            if (statusFilter) {
                statusFilter.addEventListener('change', filterCompletedRequests);
            }
            if (searchInput) {
                searchInput.addEventListener('input', filterCompletedRequests);
            }
        }

        async function loadUsers() {
            try {
                const users = await AdminManager.getUsers();
                const tbody = document.querySelector('#usersTable tbody');
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td><code>${user.id}</code></td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>
                            <span style="font-weight: bold; color: var(--success);">${user.credits}</span>
                            <button class="btn btn-sm btn-secondary" onclick="manageUserCredits('${user.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                        <td>${user.type === 'admin' ? 'Admin' : 'User'}</td>
                        <td><span class="status-pill ${user.status || 'active'}">${user.status || 'active'}</span></td>
                        <td>
                            <span class="clickable-date" onclick="showUserRegistrationDetails('${user.id}', '${user.name}', '${user.joinDate}')" title="Click for registration details">
                                ${formatDate(user.joinDate)}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-info btn-sm" onclick="viewUserDetails('${user.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                            </button>
                                <button class="btn btn-warning btn-sm" onclick="editUser('${user.id}')" title="Edit User">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-success btn-sm" onclick="viewUserActivity('${user.id}')" title="View Activity">
                                    <i class="fas fa-history"></i>
                                </button>
                                ${user.type !== 'admin' ? `
                                    <button class="btn btn-danger btn-sm" onclick="toggleUserStatus('${user.id}', '${user.status || 'active'}')" title="Toggle Status">
                                        <i class="fas fa-user-slash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--muted);">Failed to load users</td></tr>';
            }
        }

        async function loadCredits() {
            // Load user dropdowns
            await loadUserDropdowns();
            
            // Load user credits overview
            await loadUserCredits();
            
            // Load transaction history with filters
            loadTransactionHistory();
        }

        async function loadUserDropdowns() {
            try {
                const users = await AdminManager.getUsers();
                const addSelect = document.getElementById('addCreditUserId');
                const removeSelect = document.getElementById('removeCreditUserId');
                const filterSelect = document.getElementById('transactionUserFilter');
                
                const userOptions = users.map(user => 
                    `<option value="${user.id}">${user.name} (${user.email}) - ${user.credits} credits</option>`
                ).join('');
                
                if (addSelect) addSelect.innerHTML = '<option value="">Choose User...</option>' + userOptions;
                if (removeSelect) removeSelect.innerHTML = '<option value="">Choose User...</option>' + userOptions;
                if (filterSelect) filterSelect.innerHTML = '<option value="">All Users</option>' + users.map(user => 
                    `<option value="${user.id}">${user.name}</option>`
                ).join('');
            } catch (error) {
                console.error('Error loading user dropdowns:', error);
            }
        }

        async function loadUserCredits() {
            try {
                const users = await AdminManager.getUsers();
                const tbody = document.querySelector('#userCreditsTable tbody');
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.email}</td>
                        <td>
                            <span style="font-size: 18px; font-weight: bold; color: ${user.credits < 5 ? 'var(--danger)' : 'var(--success)'};">
                                ${user.credits}
                            </span>
                        </td>
                        <td>${user.type === 'admin' ? 'Admin' : 'User'}</td>
                        <td>${user.created_at ? formatDate(user.created_at) : 'Unknown'}</td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-success btn-sm" onclick="quickUserAction('${user.id}', 'add')" title="Add Credits">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="quickUserAction('${user.id}', 'remove')" title="Remove Credits">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button class="btn btn-info btn-sm" onclick="viewUserCreditHistory('${user.id}')" title="View History">
                                    <i class="fas fa-history"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading user credits:', error);
                const tbody = document.querySelector('#userCreditsTable tbody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--muted);">Failed to load users</td></tr>';
            }
        }

        async function loadTransactionHistory() {
            if (typeof CreditManager === 'undefined') return;
            
            try {
                let transactions = await CreditManager.getAllTransactions();
                const userFilter = document.getElementById('transactionUserFilter')?.value;
                const typeFilter = document.getElementById('transactionTypeFilter')?.value;
                
                // Apply filters
                if (userFilter) {
                    transactions = transactions.filter(t => t.user_id == userFilter);
                }
                
                if (typeFilter === 'positive') {
                    transactions = transactions.filter(t => t.amount > 0);
                } else if (typeFilter === 'negative') {
                    transactions = transactions.filter(t => t.amount < 0);
                }
                
            const tbody = document.querySelector('#creditsTable tbody');
                tbody.innerHTML = transactions.slice(0, 50).map(transaction => `
                    <tr>
                        <td><code>${transaction.transaction_id.substring(0, 12)}</code></td>
                        <td>${transaction.userName || 'Unknown'}</td>
                        <td style="color: ${transaction.amount > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: bold;">
                            ${transaction.amount > 0 ? '+' : ''}${transaction.amount}
                        </td>
                        <td>${transaction.reason}</td>
                        <td>${transaction.admin_name || 'System'}</td>
                        <td>${formatDate(transaction.created_at)}</td>
                        <td>${transaction.balance_after}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load transaction history:', error);
                const tbody = document.querySelector('#creditsTable tbody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--danger);">Failed to load transaction history</td></tr>';
            }
        }

        async function loadPaymentRequests() {
            try {
                console.log('Loading payment requests...');
                
                // Check if PaymentManager is available
                if (typeof PaymentManager === 'undefined') {
                    console.error('PaymentManager is not defined');
                    EnhancedUI.showToast('PaymentManager not loaded', 'error');
                    return;
                }
                
                const requests = await PaymentManager.getAllPaymentRequests();
                console.log('Payment requests loaded:', requests);
                
                // Filter to show only pending requests
                const pendingRequests = requests.filter(request => request.status === 'pending');
                
                const tbody = document.querySelector('#paymentRequestsTable tbody');
                
                if (pendingRequests.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: var(--muted);">
                                No pending payment requests
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = pendingRequests.map(request => {
                        const status = PaymentManager.formatPaymentStatus(request.status);
                        return `
                            <tr>
                                <td>${request.paymentRequestId}</td>
                                <td>${request.user.name}</td>
                                <td>${request.amount} </td>
                                <td>${request.credits}</td>
                                <td>${request.invoiceNumber}</td>
                                <td>
                                    <span class="status-badge ${status.class}">${status.text}</span>
                                </td>
                                <td>${EnhancedUI.formatDate(request.createdAt)}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-success btn-sm" onclick="approvePayment('${request.paymentRequestId}')">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="rejectPayment('${request.paymentRequestId}')">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="viewPaymentDetails('${request.paymentRequestId}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                // Also load payment history
                await loadPaymentHistory();
            } catch (error) {
                console.error('Error loading payment requests:', error);
                EnhancedUI.showToast('Failed to load payment requests: ' + error.message, 'error');
            }
        }

        async function approvePayment(paymentId) {
            console.log('Approving payment:', paymentId);
            
            if (typeof PaymentManager === 'undefined') {
                EnhancedUI.showToast('PaymentManager not loaded', 'error');
                return;
            }
            
            const notes = prompt('Enter verification notes (optional):');
            if (notes === null) return; // User cancelled
            
            try {
                console.log('Updating payment status to approved...');
                const success = await PaymentManager.updatePaymentStatus(paymentId, 'approved', notes);
                console.log('Payment update result:', success);
                
                if (success) {
                    EnhancedUI.showToast('Payment approved successfully', 'success');
                    // Refresh both tables to move approved payment from pending to history
                    await loadPaymentRequests();
                    await loadPaymentHistory();
                    await loadTransactionHistory();
                } else {
                    EnhancedUI.showToast('Failed to approve payment', 'error');
                }
            } catch (error) {
                console.error('Error approving payment:', error);
                EnhancedUI.showToast('Error: ' + error.message, 'error');
            }
        }

        async function rejectPayment(paymentId) {
            console.log('Rejecting payment:', paymentId);
            
            if (typeof PaymentManager === 'undefined') {
                EnhancedUI.showToast('PaymentManager not loaded', 'error');
                return;
            }
            
            const notes = prompt('Enter rejection reason:');
            if (!notes) return; // User cancelled or empty
            
            try {
                console.log('Updating payment status to rejected...');
                const success = await PaymentManager.updatePaymentStatus(paymentId, 'rejected', notes);
                console.log('Payment update result:', success);
                
                if (success) {
                    EnhancedUI.showToast('Payment rejected', 'warning');
                    // Refresh both tables to move rejected payment from pending to history
                    await loadPaymentRequests();
                    await loadPaymentHistory();
                } else {
                    EnhancedUI.showToast('Failed to reject payment', 'error');
                }
            } catch (error) {
                console.error('Error rejecting payment:', error);
                EnhancedUI.showToast('Error: ' + error.message, 'error');
            }
        }

        async function loadPaymentHistory() {
            try {
                console.log('Loading payment history...');
                
                if (typeof PaymentManager === 'undefined') {
                    console.error('PaymentManager is not defined');
                    return;
                }
                
                const requests = await PaymentManager.getAllPaymentRequests();
                console.log('Payment history loaded:', requests);
                
                // Filter to show only non-pending requests (approved and rejected)
                const historyRequests = requests.filter(request => request.status !== 'pending');
                
                const tbody = document.querySelector('#paymentHistoryTable tbody');
                
                if (historyRequests.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: var(--muted);">
                                No payment history found
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Sort by date (newest first)
                const sortedRequests = historyRequests.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                tbody.innerHTML = sortedRequests.map(request => {
                    const status = PaymentManager.formatPaymentStatus(request.status);
                    return `
                        <tr>
                            <td>${request.paymentRequestId}</td>
                            <td>${request.userName}</td>
                            <td>${request.amount} </td>
                            <td>${request.credits}</td>
                            <td>${request.invoiceNumber}</td>
                            <td>
                                <span class="status-badge ${status.class}">${status.text}</span>
                            </td>
                            <td>${request.verifiedByName || 'N/A'}</td>
                            <td>${EnhancedUI.formatDate(request.createdAt)}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading payment history:', error);
                EnhancedUI.showToast('Failed to load payment history: ' + error.message, 'error');
            }
        }

        function viewPaymentDetails(paymentId) {
            // This would open a modal with payment details
            EnhancedUI.showToast('Payment details view - to be implemented', 'info');
        }

        // Payment Notification System
        let paymentNotificationInterval;
        let lastPaymentCount = 0;

        function startPaymentNotifications() {
            // Check for new payments every 10 seconds
            paymentNotificationInterval = setInterval(checkForNewPayments, 10000);
            
            // Initial check
            checkForNewPayments();
        }

        function stopPaymentNotifications() {
            if (paymentNotificationInterval) {
                clearInterval(paymentNotificationInterval);
            }
        }

        async function checkForNewPayments() {
            try {
                if (typeof PaymentManager === 'undefined') return;
                
                const requests = await PaymentManager.getAllPaymentRequests();
                const pendingCount = requests.filter(request => request.status === 'pending').length;
                
                // Update notification badge
                updatePaymentNotificationBadge(pendingCount);
                
                // Show notification if new payments arrived
                if (pendingCount > lastPaymentCount && lastPaymentCount > 0) {
                    const newPayments = pendingCount - lastPaymentCount;
                    showPaymentNotification(newPayments, requests.filter(request => request.status === 'pending'));
                }
                
                lastPaymentCount = pendingCount;
            } catch (error) {
                console.error('Error checking for new payments:', error);
            }
        }

        function updatePaymentNotificationBadge(count) {
            const badge = document.getElementById('paymentNotificationBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function showPaymentNotification(newCount, pendingPayments) {
            // Play notification sound
            playNotificationSound();
            
            // Create notification popup
            const notification = document.createElement('div');
            notification.className = 'payment-notification';
            notification.innerHTML = `
                <button class="payment-notification-close" onclick="closePaymentNotification(this)">&times;</button>
                <div class="payment-notification-header">
                    <i class="fas fa-credit-card"></i>
                    <div class="payment-notification-title">New Payment${newCount > 1 ? 's' : ''} Received!</div>
                </div>
                <div class="payment-notification-body">
                    ${newCount} new payment request${newCount > 1 ? 's' : ''} waiting for approval.
                    <br><br>
                    <strong>Latest:</strong><br>
                    ${pendingPayments.slice(0, 2).map(payment => 
                        ` ${payment.userName} - ${payment.amount} (${payment.credits} credits)`
                    ).join('<br>')}
                    ${pendingPayments.length > 2 ? `<br>... and ${pendingPayments.length - 2} more` : ''}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Show notification with animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                closePaymentNotification(notification.querySelector('.payment-notification-close'));
            }, 8000);
        }

        function closePaymentNotification(closeButton) {
            const notification = closeButton.closest('.payment-notification');
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }

        function playNotificationSound() {
            // Create a simple notification sound using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Could not play notification sound:', error);
            }
        }

        async function loadActivities() {
            if (typeof ActivityLogger === 'undefined') return;
            
            try {
                const activities = await ActivityLogger.getAllActivities(100);
            const timeline = document.getElementById('activitiesTimeline');
            
            timeline.innerHTML = activities.length > 0 ? activities.map(activity => `
                <div class="timeline-item">
                    <div class="timeline-content">
                            <div class="timeline-time">${formatDate(activity.created_at)}</div>
                            <div><strong>${activity.userName || 'System'}</strong></div>
                        <div style="color: var(--muted); font-size: 12px;">${activity.description}</div>
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; color: var(--muted); padding: 20px;">No activities found</div>';
            } catch (error) {
                console.error('Failed to load activities:', error);
                const timeline = document.getElementById('activitiesTimeline');
                timeline.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 20px;">Failed to load activities</div>';
            }
        }

        async function loadRecentActivities() {
            if (typeof ActivityLogger === 'undefined') return;
            
            try {
                const activities = await ActivityLogger.getAllActivities(10);
            const timeline = document.getElementById('recentActivities');
            
            timeline.innerHTML = activities.length > 0 ? activities.map(activity => `
                <div class="timeline-item">
                    <div class="timeline-content">
                            <div class="timeline-time">${formatDate(activity.created_at)}</div>
                        <div style="font-size: 12px;">${activity.description}</div>
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; color: var(--muted); padding: 20px;">No recent activities</div>';
            } catch (error) {
                console.error('Failed to load recent activities:', error);
                const timeline = document.getElementById('recentActivities');
                timeline.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 20px;">Failed to load recent activities</div>';
            }
        }

        function loadSettings() {
            // Load default settings
            const defaultCredits = document.getElementById('defaultCredits');
            const autoProcessing = document.getElementById('autoProcessing');
            const emailNotifications = document.getElementById('emailNotifications');
            
            if (defaultCredits) defaultCredits.value = 3;
            if (autoProcessing) autoProcessing.checked = false;
            if (emailNotifications) emailNotifications.checked = true;
        }

        // Credit Management Functions
        async function quickAddCredits() {
            const userId = document.getElementById('addCreditUserId').value;
            const amount = parseInt(document.getElementById('addCreditAmount').value);
            const reason = document.getElementById('addCreditReason').value || 'Admin credit adjustment';
            
            if (!userId || !amount || amount <= 0) {
                EnhancedUI.showToast('Please fill in all fields with valid values', 'error');
                return;
            }
            
            try {
                const adminId = EnhancedAuth.getCurrentUser()?.id || 'admin';
                const success = await CreditManager.addCredits(userId, amount, reason, adminId);
                if (success) {
                    EnhancedUI.showToast(`Successfully added ${amount} credits to user`, 'success');
                    // Reset fields
                    document.getElementById('addCreditAmount').value = '';
                    document.getElementById('addCreditReason').value = '';
                    // Refresh the tables
                    loadUserCredits();
                    await loadTransactionHistory();
                } else {
                    EnhancedUI.showToast('Failed to add credits', 'error');
                }
            } catch (error) {
                EnhancedUI.showToast('Error: ' + error.message, 'error');
            }
        }
        
        async function quickRemoveCredits() {
            const userId = document.getElementById('removeCreditUserId').value;
            const amount = parseInt(document.getElementById('removeCreditAmount').value);
            const reason = document.getElementById('removeCreditReason').value || 'Admin credit deduction';
            
            if (!userId || !amount || amount <= 0) {
                EnhancedUI.showToast('Please fill in all fields with valid values', 'error');
                return;
            }
            
            try {
                const adminId = EnhancedAuth.getCurrentUser()?.id || 'admin';
                const success = await CreditManager.deductCredits(userId, amount, reason, adminId);
                if (success) {
                    EnhancedUI.showToast(`Successfully removed ${amount} credits from user`, 'success');
                    // Reset fields
                    document.getElementById('removeCreditAmount').value = '';
                    document.getElementById('removeCreditReason').value = '';
                    // Refresh the tables
                    loadUserCredits();
                    await loadTransactionHistory();
                } else {
                    EnhancedUI.showToast('Failed to remove credits', 'error');
                }
            } catch (error) {
                EnhancedUI.showToast('Error: ' + error.message, 'error');
            }
        }
        
        function bulkAddCredits() {
            const amount = parseInt(document.getElementById('bulkAmount').value);
            const reason = document.getElementById('bulkReason').value || 'Bulk credit adjustment';
            
            if (!amount || amount <= 0 || !reason) {
                EnhancedUI.showToast('Please enter a valid amount and reason', 'error');
                return;
            }
            
            // Confirm with the admin
            if (!confirm(`Are you sure you want to add ${amount} credits to ALL active users?`)) {
                return;
            }
            
            if (typeof UserManager !== 'undefined' && typeof CreditManager !== 'undefined') {
                const users = Object.values(UserManager.getAllUsers()).filter(user => (user.status || 'active') === 'active');
                const adminId = EnhancedAuth?.getCurrentUser()?.id || 'admin';
                let successCount = 0;
                
                users.forEach(user => {
                    try {
                        CreditManager.addCredits(user.id, amount, reason, adminId);
                        successCount++;
                    } catch (error) {
                        console.error(`Failed to add credits to user ${user.id}: ${error.message}`);
                    }
                });
                
                EnhancedUI.showToast(`Added ${amount} credits to ${successCount} users`, 'success');
                document.getElementById('bulkAmount').value = '';
                document.getElementById('bulkReason').value = '';
                loadUserCredits();
                loadTransactionHistory();
            }
        }
        
        function showBulkUserSelector() {
            if (typeof UserManager === 'undefined') return;
            
            const users = Object.values(UserManager.getAllUsers());
            const amount = parseInt(document.getElementById('bulkAmount').value);
            const reason = document.getElementById('bulkReason').value || 'Selected users credit adjustment';
            
            if (!amount || amount <= 0) {
                EnhancedUI.showToast('Please enter a valid amount', 'error');
                return;
            }
            
            const userCheckboxes = users.map(user => `
                <div style="margin-bottom: 8px;">
                    <input type="checkbox" id="user_${user.id}" value="${user.id}">
                    <label for="user_${user.id}">
                        ${user.name} (${user.email}) - ${user.credits} credits
                    </label>
                </div>
            `).join('');
            
            showModal('Select Users for Credit Addition', `
                <div style="margin-bottom: 20px; padding: 16px; background: var(--panel2); border-radius: 8px; border-left: 4px solid var(--success);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <i class="fas fa-coins" style="color: var(--success);"></i>
                        <strong style="color: var(--success);">Credit Addition Details</strong>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                        <div><strong>Amount:</strong> <span style="color: var(--success); font-weight: 600;">${amount} credits</span></div>
                        <div><strong>Reason:</strong> <span style="color: var(--text);">${reason}</span></div>
                    </div>
                </div>
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="selectAllUsers()" style="padding: 8px 16px; border-radius: 6px;">
                        <i class="fas fa-check-double" style="margin-right: 6px;"></i>Select All
                    </button>
                    <button class="btn btn-secondary" onclick="deselectAllUsers()" style="padding: 8px 16px; border-radius: 6px;">
                        <i class="fas fa-times" style="margin-right: 6px;"></i>Deselect All
                    </button>
                </div>
                <div style="max-height: 300px; overflow-y: auto; padding: 16px; border: 1px solid var(--border); border-radius: 8px; background: var(--panel2);">
                    ${userCheckboxes}
                </div>
            `, [
                {
                    text: 'Cancel',
                    class: 'btn-secondary',
                    onclick: 'closeModal()',
                    icon: 'fas fa-times'
                },
                {
                    text: 'Add Credits to Selected Users',
                    class: 'btn-success',
                    onclick: 'addCreditsToSelectedUsers(); closeModal();',
                    icon: 'fas fa-plus'
                }
            ], { 
                icon: 'users', 
                subtitle: 'Choose which users will receive credits',
                width: '700px'
            });
        }
        
        function quickUserAction(userId, action) {
            if (typeof UserManager === 'undefined') return;
            
            const user = UserManager.getUserById(userId);
            if (!user) return;
            
            let amount = prompt(`Enter ${action === 'add' ? 'amount to add' : 'amount to remove'} for ${user.name}:`);
            amount = parseInt(amount);
            
            if (!amount || isNaN(amount) || amount <= 0) {
                EnhancedUI.showToast('Please enter a valid amount', 'error');
                return;
            }
            
            const reason = prompt('Enter reason:') || `Quick ${action === 'add' ? 'addition' : 'deduction'} by admin`;
            const adminId = EnhancedAuth?.getCurrentUser()?.id || 'admin';
            
            try {
                if (typeof CreditManager !== 'undefined') {
                    if (action === 'add') {
                        CreditManager.addCredits(userId, amount, reason, adminId);
                        EnhancedUI.showToast(`Added ${amount} credits to ${user.name}`, 'success');
                    } else {
                        CreditManager.deductCredits(userId, amount, reason, adminId);
                        EnhancedUI.showToast(`Removed ${amount} credits from ${user.name}`, 'warning');
                    }
                    loadUserCredits();
                    loadTransactionHistory();
                }
            } catch (error) {
                EnhancedUI.showToast('Error: ' + error.message, 'error');
            }
        }

        function viewUserCreditHistory(userId) {
            if (typeof UserManager === 'undefined' || typeof CreditManager === 'undefined') return;
            
            const user = UserManager.getUserById(userId);
            if (!user) return;
            
            const transactions = CreditManager.getUserTransactions(userId);
            
            showModal(`Credit History: ${user.name}`, `
                <div style="margin-bottom: 15px;">
                    <strong>User:</strong> ${user.name} (${user.email})<br>
                    <strong>Current Credits:</strong> ${user.credits}<br>
                    <strong>Total Earned:</strong> ${user.totalCreditsEarned || 0}<br>
                    <strong>Total Spent:</strong> ${user.totalCreditsSpent || 0}
                </div>
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Reason</th>
                                <th>Performed By</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactions.map(t => `
                                <tr>
                                    <td>${formatDate(t.timestamp)}</td>
                                    <td style="color: ${t.amount > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: bold;">
                                        ${t.amount > 0 ? '+' : ''}${t.amount}
                                    </td>
                                    <td>${t.reason}</td>
                                    <td>${t.performedBy}</td>
                                    <td>${t.balanceAfter}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `);
        }

        async function exportUserCredits() {
            try {
                const users = await AdminManager.getUsers();
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Name,Email,Current Credits,Type,Created Date\n";
                
                users.forEach(user => {
                    csvContent += `"${user.name}","${user.email}","${user.credits}","${user.type}","${user.created_at}"\n`;
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "user_credits_export.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                EnhancedUI.showToast('User credits exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting user credits:', error);
                EnhancedUI.showToast('Failed to export user credits', 'error');
            }
        }
        
        async function bulkAddCredits() {
            const amount = parseInt(document.getElementById('bulkAmount').value);
            const reason = document.getElementById('bulkReason').value || 'Bulk credit adjustment';
            
            if (!amount || amount <= 0 || !reason) {
                EnhancedUI.showToast('Please enter a valid amount and reason', 'error');
                return;
            }
            
            try {
                const users = await AdminManager.getUsers();
                const activeUsers = users.filter(user => user.type !== 'admin');
                const adminId = EnhancedAuth.getCurrentUser()?.id || 'admin';
                let successCount = 0;
                
                for (const user of activeUsers) {
                    try {
                        const success = await CreditManager.addCredits(user.id, amount, reason, adminId);
                        if (success) successCount++;
                    } catch (error) {
                        console.error(`Failed to add credits to user ${user.name}:`, error);
                    }
                }
                
                EnhancedUI.showToast(`Added ${amount} credits to ${successCount} users`, 'success');
                document.getElementById('bulkAmount').value = '';
                document.getElementById('bulkReason').value = '';
                loadUserCredits();
            } catch (error) {
                console.error('Error in bulk add credits:', error);
                EnhancedUI.showToast('Error in bulk credit operation', 'error');
            }
        }
        
        async function quickUserAction(userId, action) {
            try {
                const users = await AdminManager.getUsers();
                const user = users.find(u => u.id == userId);
                if (!user) {
                    EnhancedUI.showToast('User not found', 'error');
                    return;
                }
                
                const amount = prompt(`Enter amount to ${action}:`);
                if (!amount || isNaN(amount) || amount <= 0) {
                    EnhancedUI.showToast('Please enter a valid amount', 'error');
                    return;
                }
                
                const reason = prompt('Enter reason:') || `Quick ${action} by admin`;
                const adminId = EnhancedAuth?.getCurrentUser()?.id || 'admin';
                
                let success;
                if (action === 'add') {
                    success = await CreditManager.addCredits(userId, parseInt(amount), reason, adminId);
                } else {
                    success = await CreditManager.deductCredits(userId, parseInt(amount), reason, adminId);
                }
                
                if (success) {
                    EnhancedUI.showToast(`Credits ${action}ed successfully`, 'success');
                    loadUserCredits();
                } else {
                    EnhancedUI.showToast(`Failed to ${action} credits`, 'error');
                }
            } catch (error) {
                console.error(`Error in quick user action:`, error);
                EnhancedUI.showToast('Error processing request', 'error');
            }
        }
        
        function showBulkUserSelector() {
            EnhancedUI.showToast('Bulk user selector feature coming soon', 'info');
        }
        
        function viewUserCreditHistory(userId) {
            EnhancedUI.showToast('Credit history feature coming soon', 'info');
        }

        // Action functions
        async function processRequest(requestId) {
            try {
                const success = await AdminManager.updateRequestStatus(requestId, 'processed');
                if (success) {
                    EnhancedUI.showToast('Request processed successfully!', 'success');
                    loadVinRequests();
                    loadRecentRequests();
                } else {
                    EnhancedUI.showToast('Failed to process request', 'error');
                }
            } catch (error) {
                console.error('Error processing request:', error);
                EnhancedUI.showToast('Failed to process request', 'error');
            }
        }

        function uploadPDFAndProcess(requestId) {
            const fileInput = document.getElementById('pdfFile');
            const notes = document.getElementById('processingNotes').value;
            const file = fileInput.files[0];

            if (!file) {
                EnhancedUI.showToast('Please select a PDF file', 'error');
                return;
            }

            if (file.type !== 'application/pdf') {
                EnhancedUI.showToast('Please select a valid PDF file', 'error');
                return;
            }

            if (typeof PDFManager !== 'undefined' && typeof EnhancedAuth !== 'undefined') {
                const adminId = EnhancedAuth.getCurrentUser()?.id || 'admin';
                
                PDFManager.uploadPDF(requestId, file, adminId)
                    .then(result => {
                        EnhancedUI.showToast('PDF uploaded and request processed successfully!', 'success');
                        refreshCurrentSection();
                    })
                    .catch(error => {
                        EnhancedUI.showToast('Error processing request: ' + error.message, 'error');
                    });
            }
        }

        async function rejectRequest(requestId) {
            const reason = prompt('Enter rejection reason:');
            if (reason) {
                try {
                    const success = await AdminManager.updateRequestStatus(requestId, 'rejected', reason);
                    if (success) {
                EnhancedUI.showToast('Request rejected', 'warning');
                        loadVinRequests();
                        loadRecentRequests();
                        
                        // Show notification that request moved to completed section
                        setTimeout(() => {
                            EnhancedUI.showToast('Request moved to completed section!', 'info');
                        }, 1000);
                    } else {
                        EnhancedUI.showToast('Failed to reject request', 'error');
                    }
                } catch (error) {
                    console.error('Error rejecting request:', error);
                    EnhancedUI.showToast('Failed to reject request', 'error');
                }
            }
        }

        function uploadPDF(requestId) {
            // Create file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf';
            fileInput.style.display = 'none';
            
            fileInput.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.type !== 'application/pdf') {
                    EnhancedUI.showToast('Please select a valid PDF file', 'error');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    EnhancedUI.showToast('File size must be less than 10MB', 'error');
                    return;
                }
                
                try {
                    EnhancedUI.showToast('Uploading PDF...', 'info');
                    const adminId = EnhancedAuth?.getCurrentUser()?.id || 'admin';
                    
                    // Check if PDFManager is available
                    if (typeof PDFManager === 'undefined') {
                        throw new Error('PDFManager not available');
                    }
                    
                    const success = await PDFManager.uploadPDF(requestId, file, adminId);
                    
                    if (success) {
                        EnhancedUI.showToast('PDF uploaded successfully!', 'success');
                        // Update request status to processed
                        await AdminManager.updateRequestStatus(requestId, 'processed');
                        loadVinRequests();
                        loadRecentRequests();
                    } else {
                        EnhancedUI.showToast('Failed to upload PDF', 'error');
                    }
                } catch (error) {
                    console.error('Error uploading PDF:', error);
                    EnhancedUI.showToast('Error uploading PDF: ' + error.message, 'error');
                }
            };
            
            // Trigger file selection
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        async function sendPDF(requestId) {
            try {
                const adminId = EnhancedAuth?.getCurrentUser()?.id || 'admin';
                const success = await PDFManager.sendPDFToUser(requestId, adminId);
                
                if (success) {
                    EnhancedUI.showToast('PDF sent to user successfully!', 'success');
                    // Update request status to delivered
                    await AdminManager.updateRequestStatus(requestId, 'delivered');
                    loadVinRequests();
                    loadRecentRequests();
                } else {
                    EnhancedUI.showToast('Failed to send PDF', 'error');
                }
            } catch (error) {
                console.error('Error sending PDF:', error);
                EnhancedUI.showToast('Error sending PDF: ' + error.message, 'error');
            }
        }

        // New improved workflow functions
        async function completeRequest(requestId) {
            try {
                // First, check if PDF is already uploaded
                const requests = await AdminManager.getRequests();
                const request = requests.find(r => r.requestId === requestId);
                
                if (!request) {
                    EnhancedUI.showToast('Request not found', 'error');
                    return;
                }

                // If no PDF exists, prompt for upload first
                if (!request.pdf_filename) {
                    EnhancedUI.showToast('Please upload a PDF first using "Upload PDF Only" button', 'warning');
                    return;
                }

                // Confirm completion
                const confirmed = confirm(`Complete this request and send PDF to ${request.userName || 'customer'}?\n\nThis will mark the request as delivered and notify the customer.`);
                if (!confirmed) return;

                // Send PDF to customer and mark as delivered
                const adminId = EnhancedAuth?.getCurrentUser()?.id || 'admin';
                const success = await PDFManager.sendPDFToUser(requestId, adminId);
                
                if (success) {
                    // Update status to delivered
                    await AdminManager.updateRequestStatus(requestId, 'delivered');
                    EnhancedUI.showToast('Request completed! PDF sent to customer successfully!', 'success');
                    loadVinRequests();
                    loadRecentRequests();
                    
                    // Show notification that request moved to completed section
                    setTimeout(() => {
                        EnhancedUI.showToast('Request moved to completed section!', 'info');
                    }, 1000);
                } else {
                    EnhancedUI.showToast('Failed to send PDF to customer', 'error');
                }
                
            } catch (error) {
                console.error('Error completing request:', error);
                EnhancedUI.showToast('Failed to complete request: ' + error.message, 'error');
            }
        }

        async function viewPDF(requestId) {
            try {
                // Get authentication token
                const token = TokenManager.getAccessToken();
                if (!token) {
                    EnhancedUI.showToast('Authentication required to view PDF', 'error');
                    return;
                }

                // Create a blob URL for the PDF
                const response = await fetch(`http://localhost:3001/api/admin/download-pdf/${requestId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Get the PDF blob
                const blob = await response.blob();
                
                // Create object URL and open in new tab
                const pdfUrl = URL.createObjectURL(blob);
                const newWindow = window.open(pdfUrl, '_blank');
                
                if (!newWindow) {
                    EnhancedUI.showToast('Please allow popups to view PDF', 'warning');
                    return;
                }

                // Clean up the object URL after a delay
                setTimeout(() => {
                    URL.revokeObjectURL(pdfUrl);
                }, 10000);

            } catch (error) {
                console.error('Error viewing PDF:', error);
                EnhancedUI.showToast('Failed to view PDF: ' + error.message, 'error');
            }
        }

        async function resendPDF(requestId) {
            try {
                const adminId = EnhancedAuth?.getCurrentUser()?.id || 'admin';
                const success = await PDFManager.sendPDFToUser(requestId, adminId);
                
                if (success) {
                    EnhancedUI.showToast('PDF resent to customer successfully!', 'success');
                } else {
                    EnhancedUI.showToast('Failed to resend PDF', 'error');
                }
            } catch (error) {
                console.error('Error resending PDF:', error);
                EnhancedUI.showToast('Failed to resend PDF: ' + error.message, 'error');
            }
        }

        async function viewRequest(requestId) {
            try {
                // Get request details from AdminManager
                const requests = await AdminManager.getRequests();
                const request = requests.find(r => r.requestId === requestId);
                
                if (!request) {
                    EnhancedUI.showToast('Request not found', 'error');
                    return;
                }

                // Parse report data if available
                let reportData = null;
                if (request.report_data) {
                    try {
                        reportData = JSON.parse(request.report_data);
                    } catch (e) {
                        console.log('Could not parse report data:', e);
                    }
                }

                // Calculate time since creation and processing
                const createdDate = new Date(request.createdAt);
                const processedDate = request.processedAt ? new Date(request.processedAt) : null;
                const now = new Date();
                
                const timeSinceCreation = now - createdDate;
                const daysAgo = Math.floor(timeSinceCreation / (1000 * 60 * 60 * 24));
                const hoursAgo = Math.floor(timeSinceCreation / (1000 * 60 * 60));
                const minutesAgo = Math.floor(timeSinceCreation / (1000 * 60));
                
                let timeAgo = '';
                if (daysAgo > 0) {
                    timeAgo = `${daysAgo} day${daysAgo > 1 ? 's' : ''} ago`;
                } else if (hoursAgo > 0) {
                    timeAgo = `${hoursAgo} hour${hoursAgo > 1 ? 's' : ''} ago`;
                } else if (minutesAgo > 0) {
                    timeAgo = `${minutesAgo} minute${minutesAgo > 1 ? 's' : ''} ago`;
                } else {
                    timeAgo = 'Just now';
                }

                // Calculate processing time if processed
                let processingTime = '';
                if (processedDate) {
                    const processingDuration = processedDate - createdDate;
                    const processingHours = Math.floor(processingDuration / (1000 * 60 * 60));
                    const processingMinutes = Math.floor((processingDuration % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (processingHours > 0) {
                        processingTime = `${processingHours}h ${processingMinutes}m`;
                    } else {
                        processingTime = `${processingMinutes}m`;
                    }
                }

            showModal('VIN Request Details', `
                    <div class="vin-details-container">
                        <!-- Custom Header with Close Button -->
                        <div class="vin-header-with-close">
                        <div class="vin-header">
                            <div class="vin-title">
                                <i class="fas fa-car" style="color: var(--primary); margin-right: 8px;"></i>
                                    <span>VIN Request ${request.requestId}</span>
                                    <div class="vin-subtitle">Request #${request.id}</div>
                    </div>
                            <div class="vin-status">
                        <span class="status-pill ${request.status}">${getStatusText(request.status)}</span>
                                    ${processingTime ? `<div class="processing-time">Processed in ${processingTime}</div>` : ''}
                    </div>
                    </div>
                            <button class="vin-close-btn" onclick="closeModal()" title="Close">
                                <i class="fas fa-times"></i>
                            </button>
                    </div>

                        <!-- Compact Layout - Two Columns -->
                        <div class="vin-compact-layout">
                            <!-- Left Column - Main Info -->
                            <div class="vin-left-column">
                                <!-- Essential Info Grid -->
                                <div class="vin-essential-info">
                            <div class="info-card warning">
                                <div class="info-icon">
                                    <i class="fas fa-barcode"></i>
                </div>
                                <div class="info-content">
                                    <div class="info-label">VIN Number</div>
                                    <div class="info-value vin-number">${request.vin}</div>
                                </div>
                            </div>

                            <div class="info-card info">
                                <div class="info-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="info-content">
                                    <div class="info-label">Customer</div>
                                            <div class="info-value">${request.userName}</div>
                                </div>
                            </div>

                                    <div class="info-card secondary">
                                <div class="info-icon">
                                            <i class="fas fa-clock"></i>
                                </div>
                                <div class="info-content">
                                            <div class="info-label">Created</div>
                                            <div class="info-value">${formatDate(request.createdAt)}</div>
                                </div>
                            </div>

                                    ${request.processedAt ? `
                                        <div class="info-card success">
                                <div class="info-icon">
                                                <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="info-content">
                                                <div class="info-label">Processed</div>
                                                <div class="info-value">${formatDate(request.processedAt)}</div>
                                </div>
                            </div>
                                    ` : ''}

                            ${request.processed_by ? `
                                <div class="info-card success">
                                    <div class="info-icon">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="info-content">
                                        <div class="info-label">Processed By</div>
                                                <div class="info-value">Admin #${request.processed_by}</div>
                                    </div>
                    </div>
                ` : ''}
                        </div>

                                <!-- Processing Notes -->
                                ${request.processing_notes ? `
                                    <div class="vin-section-compact">
                                        <div class="section-header-compact">
                                            <i class="fas fa-sticky-note"></i>
                                            <span>Processing Notes</span>
                                </div>
                                        <div class="notes-content-compact">
                                            ${request.processing_notes}
                                    </div>
                    </div>
                ` : ''}
                                        </div>

                            <!-- Right Column - PDF & Actions -->
                            <div class="vin-right-column">
                        <!-- PDF Report Section -->
                                <div class="vin-section-compact">
                                    <div class="section-header-compact">
                                        <i class="fas fa-file-pdf"></i>
                                    <span>PDF Report</span>
                                        ${request.pdf_filename ? 
                                            `<span class="status-badge success">READY</span>` : 
                                            `<span class="status-badge warning">PENDING</span>`
                                        }
                                </div>
                                    
                                    ${request.pdf_filename ? `
                                        <div class="pdf-info-compact">
                                            <div class="pdf-icon-compact">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                            <div class="pdf-details-compact">
                                                <div class="pdf-name-compact">${request.pdf_filename}</div>
                                                <div class="pdf-status-compact">
                                                    <i class="fas fa-check-circle"></i> Ready for customer
                                    </div>
                                </div>
                                            <div class="pdf-actions-compact">
                                                <button class="btn btn-sm btn-info" onclick="viewPDF('${request.requestId}')" title="View PDF">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-primary" onclick="downloadPDF('${request.requestId}')" title="Download PDF">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button class="btn btn-sm btn-success" onclick="sendPDF('${request.requestId}'); closeModal();" title="Send to Customer">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                            </div>
                                </div>
                                    ` : `
                                        <div class="no-pdf-info-compact">
                                            <div class="no-pdf-icon-compact">
                                                <i class="fas fa-file-plus"></i>
                                </div>
                                            <div class="no-pdf-text-compact">
                                                <div class="no-pdf-title-compact">No PDF uploaded</div>
                                                <div class="no-pdf-subtitle-compact">Upload a PDF to attach to this request</div>
                            </div>
                                            <button class="btn btn-sm btn-outline" onclick="uploadPDF('${request.requestId}'); closeModal();" title="Upload PDF">
                                                <i class="fas fa-upload"></i>
                                            </button>
                                        </div>
                                    `}
                                </div>

                        <!-- Action Buttons -->
                                <div class="vin-actions-compact">
                                    <div class="action-group primary">
                            ${request.status === 'pending' ? `
                                            <button class="btn btn-primary btn-sm" onclick="processRequest('${request.requestId}'); closeModal();">
                                    <i class="fas fa-play"></i> Process Request
                                </button>
                                            <button class="btn btn-warning btn-sm" onclick="rejectRequest('${request.requestId}'); closeModal();">
                                                <i class="fas fa-times"></i> Reject Request
                                            </button>
                            ` : ''}
                                        ${request.status === 'processed' ? `
                                            <button class="btn btn-success btn-sm" onclick="completeRequest('${request.requestId}'); closeModal();">
                                                <i class="fas fa-check-double"></i> Complete & Send PDF
                                            </button>
                                            <button class="btn btn-outline btn-sm" onclick="uploadPDF('${request.requestId}'); closeModal();">
                                    <i class="fas fa-upload"></i> Upload PDF
                                </button>
                                            <button class="btn btn-warning btn-sm" onclick="markAsPending('${request.requestId}'); closeModal();">
                                                <i class="fas fa-undo"></i> Revert
                                </button>
                            ` : ''}
                                        ${request.status === 'delivered' ? `
                                            <button class="btn btn-info btn-sm" onclick="viewPDF('${request.requestId}');">
                                                <i class="fas fa-eye"></i> View PDF
                                            </button>
                                            <button class="btn btn-outline btn-sm" onclick="resendPDF('${request.requestId}'); closeModal();">
                                                <i class="fas fa-paper-plane"></i> Resend PDF
                                            </button>
                                        ` : ''}
                                        ${request.status === 'rejected' ? `
                                            <button class="btn btn-primary btn-sm" onclick="markAsPending('${request.requestId}'); closeModal();">
                                                <i class="fas fa-redo"></i> Restore Request
                                </button>
                            ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <style>
                        .vin-details-container {
                max-width: 1100px;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        }

            .vin-header-with-close {
                position: relative;
                margin-bottom: 12px;
            }

                        .vin-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                padding: 10px 14px;
                background: linear-gradient(135deg, var(--primary), #4f46e5);
                            color: white;
                border-radius: 6px;
            }

            .vin-close-btn {
                position: absolute;
                top: -6px;
                right: -6px;
                width: 28px;
                height: 28px;
                background: var(--danger);
                border: none;
                border-radius: 50%;
                color: white;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                transition: all 0.2s ease;
                z-index: 10;
            }

            .vin-close-btn:hover {
                background: #dc2626;
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }

            .vin-close-btn:active {
                transform: scale(0.95);
            }

            .vin-compact-layout {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                height: 100%;
            }

            .vin-left-column,
            .vin-right-column {
                display: flex;
                flex-direction: column;
                gap: 16px;
                        }

                        .vin-title {
                font-size: 20px;
                font-weight: 600;
                            display: flex;
                            align-items: center;
                        }

            .vin-subtitle {
                font-size: 13px;
                opacity: 0.8;
                margin-left: 8px;
                font-weight: 400;
            }

            .vin-status {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .processing-time {
                font-size: 12px;
                opacity: 0.9;
                padding: 3px 6px;
                background: rgba(255,255,255,0.2);
                border-radius: 4px;
            }

                        .vin-status .status-pill {
                font-size: 12px;
                padding: 4px 8px;
                border-radius: 12px;
                font-weight: 500;
                            text-transform: uppercase;
                        }

            .vin-essential-info {
                            display: grid;
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .vin-section-compact {
                background: var(--panel2);
                border-radius: 8px;
                padding: 16px;
            }

            .section-header-compact {
                font-size: 16px;
                font-weight: 600;
                color: var(--text);
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .status-badge {
                font-size: 11px;
                padding: 3px 8px;
                border-radius: 10px;
                font-weight: 500;
                text-transform: uppercase;
                margin-left: auto;
            }

            .status-badge.success { 
                background: var(--success); 
                color: white; 
            }

            .status-badge.warning { 
                background: var(--warning); 
                color: white; 
                        }

                        .info-card {
                            display: flex;
                            align-items: center;
                padding: 12px;
                            background: var(--panel2);
                border-radius: 6px;
                            border-left: 4px solid;
                transition: all 0.2s ease;
                        }

                        .info-card:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .pdf-info-compact {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px;
                background: var(--bg);
                border-radius: 4px;
                border: 1px solid var(--border);
            }

            .pdf-icon-compact {
                width: 40px;
                height: 40px;
                background: var(--danger);
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                color: white;
            }

            .pdf-details-compact {
                flex: 1;
                min-width: 0;
            }

            .pdf-name-compact {
                font-size: 14px;
                font-weight: 600;
                color: var(--text);
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .pdf-status-compact {
                font-size: 12px;
                color: var(--success);
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .pdf-actions-compact {
                display: flex;
                gap: 6px;
            }

            .pdf-actions-compact .btn {
                padding: 8px 12px;
                font-size: 12px;
                font-weight: 600;
                border-radius: 5px;
                min-height: 36px;
                min-width: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 4px;
            }

            .no-pdf-info-compact {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: var(--bg);
                border-radius: 6px;
                border: 2px dashed var(--border);
            }

            .no-pdf-info-compact .btn {
                padding: 10px 16px;
                font-size: 13px;
                font-weight: 600;
                border-radius: 6px;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }

            .no-pdf-icon-compact {
                width: 40px;
                height: 40px;
                background: var(--muted);
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                color: white;
            }

            .no-pdf-text-compact {
                flex: 1;
            }

            .no-pdf-title-compact {
                font-size: 14px;
                font-weight: 600;
                color: var(--text);
                margin-bottom: 4px;
            }

            .no-pdf-subtitle-compact {
                font-size: 12px;
                color: var(--muted);
            }

            .vin-actions-compact {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .vin-actions-compact .btn {
                padding: 10px 16px;
                font-size: 14px;
                font-weight: 600;
                border-radius: 6px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .vin-actions-compact .btn-sm {
                padding: 8px 14px;
                font-size: 13px;
                min-height: 40px;
            }

            .vin-actions-compact .btn:hover {
                            transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }

            .pdf-actions-compact .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            }

            .no-pdf-info-compact .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            }

            .notes-content-compact {
                padding: 12px;
                background: var(--bg);
                border-radius: 6px;
                border: 1px solid var(--border);
                font-size: 14px;
                color: var(--text);
                line-height: 1.5;
                        }

                        .info-card.primary { border-left-color: var(--primary); }
                        .info-card.warning { border-left-color: var(--warning); }
                        .info-card.info { border-left-color: var(--info); }
                        .info-card.accent { border-left-color: var(--accent); }
                        .info-card.secondary { border-left-color: var(--secondary); }
                        .info-card.success { border-left-color: var(--success); }

                        .info-icon {
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 10px;
                            font-size: 14px;
                            color: white;
                        }

                        .info-card.primary .info-icon { background: var(--primary); }
                        .info-card.warning .info-icon { background: var(--warning); }
                        .info-card.info .info-icon { background: var(--info); }
                        .info-card.accent .info-icon { background: var(--accent); }
                        .info-card.secondary .info-icon { background: var(--secondary); }
                        .info-card.success .info-icon { background: var(--success); }

                        .info-content {
                            flex: 1;
                        }

                        .info-label {
                            font-size: 11px;
                            color: var(--muted);
                            margin-bottom: 2px;
                            font-weight: 500;
                            text-transform: uppercase;
                            letter-spacing: 0.3px;
                        }

                        .info-value {
                            font-size: 14px;
                            font-weight: 600;
                            color: var(--text);
                            margin-bottom: 1px;
                        }

                        .info-sub {
                            font-size: 11px;
                            color: var(--muted);
                        }

                        .vin-number {
                            font-family: 'Courier New', monospace;
                            font-size: 14px;
                            letter-spacing: 0.5px;
                        }

                        .vin-section {
                            background: var(--panel2);
                            border-radius: 8px;
                            padding: 16px;
                            margin-bottom: 16px;
                        }

                        .section-header {
                            font-size: 16px;
                            font-weight: 600;
                            color: var(--text);
                            margin-bottom: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        }

                        .section-badge {
                            font-size: 10px;
                            padding: 2px 6px;
                            border-radius: 4px;
                            font-weight: 500;
                            text-transform: uppercase;
                        }

                        .section-badge.success { background: var(--success); color: white; }
                        .section-badge.warning { background: var(--warning); color: white; }


                        .pdf-info {
                            display: flex;
                            align-items: center;
                            padding: 16px;
                            background: var(--bg);
                            border-radius: 8px;
                            border: 1px solid var(--border);
                        }

                        .pdf-icon {
                            width: 48px;
                            height: 48px;
                            background: var(--danger);
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 16px;
                            font-size: 24px;
                            color: white;
                        }

                        .pdf-details {
                            flex: 1;
                        }

                        .pdf-name {
                            font-size: 16px;
                            font-weight: 600;
                            color: var(--text);
                            margin-bottom: 4px;
                        }

                        .pdf-status {
                            font-size: 12px;
                            color: var(--success);
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        }

                        .pdf-status.success {
                            color: var(--success);
                        }

                        .pdf-note {
                            font-size: 11px;
                            color: var(--success);
                            font-style: italic;
                            margin-top: 4px;
                        }

                        .no-pdf-info {
                            display: flex;
                            align-items: center;
                            padding: 20px;
                            background: var(--bg);
                            border-radius: 8px;
                            border: 2px dashed var(--border);
                        }

                        .no-pdf-icon {
                            width: 48px;
                            height: 48px;
                            background: var(--muted);
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 16px;
                            font-size: 24px;
                            color: white;
                        }

                        .no-pdf-text {
                            flex: 1;
                        }

                        .no-pdf-title {
                            font-size: 16px;
                            font-weight: 600;
                            color: var(--text);
                            margin-bottom: 4px;
                        }

                        .no-pdf-subtitle {
                            font-size: 13px;
                            color: var(--muted);
                            line-height: 1.4;
                        }

                        .no-pdf-actions {
                            margin-left: 16px;
                        }

                        .pdf-actions {
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            flex-wrap: wrap;
                        }

                        .notes-content {
                            padding: 16px;
                            background: var(--bg);
                            border-radius: 8px;
                            border: 1px solid var(--border);
                            font-style: italic;
                            color: var(--text);
                        }

                        .vin-actions {
                            display: flex;
                            gap: 8px;
                            flex-wrap: wrap;
                            margin-top: 16px;
                            padding-top: 16px;
                            border-top: 1px solid var(--border);
                        }

                        .action-group {
                            display: flex;
                            gap: 8px;
                            flex-wrap: wrap;
                        }

                        .action-group.primary {
                            flex: 1;
                        }

                        .action-group.secondary {
                            margin-left: auto;
                        }

                        .vin-actions .btn {
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            padding: 8px 12px;
                            border-radius: 6px;
                            font-weight: 500;
                            text-decoration: none;
                            transition: all 0.2s ease;
                            font-size: 13px;
                        }

                        .vin-actions .btn.btn-lg {
                            padding: 10px 16px;
                            font-size: 14px;
                        }

                        .vin-actions .btn:hover {
                            transform: translateY(-1px);
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        }

                        @media (max-width: 768px) {
                .vin-details-container {
                    max-width: 100%;
                }
                
                .vin-compact-layout {
                                grid-template-columns: 1fr;
                    gap: 12px;
                            }
                            
                .vin-essential-info {
                                grid-template-columns: 1fr;
                            }
                            
                .pdf-actions-compact {
                    flex-wrap: wrap;
                    justify-content: center;
                }
                
                .pdf-actions-compact .btn {
                    min-width: 44px;
                    min-height: 44px;
                }
                
                .vin-actions-compact .btn {
                                width: 100%;
                                justify-content: center;
                    min-height: 48px;
                }
                
                .no-pdf-info-compact .btn {
                    min-height: 44px;
                            }
                        }
                    </style>
            `, [], { 
                icon: 'car', 
                    subtitle: 'Comprehensive VIN request information and management',
                width: '1100px',
                hideHeader: true
            });
            } catch (error) {
                console.error('Error viewing request:', error);
                EnhancedUI.showToast('Failed to load request details', 'error');
            }
        }

        function manageUserCredits(userId) {
            if (typeof UserManager === 'undefined') return;
            
            const user = UserManager.getUserById(userId);
            if (!user) return;

            showModal('Manage User Credits', `
                <div style="margin-bottom: 15px;">
                    <strong>User:</strong> ${user.name} (${user.email})<br>
                    <strong>Current Credits:</strong> ${user.credits}
                </div>
                <div class="form-group">
                    <label class="form-label">Credit Amount</label>
                    <input type="number" id="creditAmount" class="form-control" placeholder="Enter amount (positive to add, negative to deduct)">
                </div>
                <div class="form-group">
                    <label class="form-label">Reason</label>
                    <input type="text" id="creditReason" class="form-control" placeholder="Enter reason for credit adjustment">
                </div>
            `, [
                {
                    text: 'Apply Changes',
                    class: 'btn-success',
                    onclick: `applyCreditChanges('${userId}'); closeModal();`
                }
            ]);
        }

        function applyCreditChanges(userId) {
            const amount = parseInt(document.getElementById('creditAmount').value);
            const reason = document.getElementById('creditReason').value;

            if (!amount || !reason) {
                EnhancedUI.showToast('Please fill in all fields', 'error');
                return;
            }

            try {
                if (typeof CreditManager !== 'undefined') {
                    const adminId = EnhancedAuth?.getCurrentUser()?.id || 'admin';
                    if (amount > 0) {
                        CreditManager.addCredits(userId, amount, reason, adminId);
                    } else {
                        CreditManager.deductCredits(userId, Math.abs(amount), reason, adminId);
                    }
                    EnhancedUI.showToast('Credits updated successfully', 'success');
                    refreshCurrentSection();
                }
            } catch (error) {
                EnhancedUI.showToast('Error: ' + error.message, 'error');
            }
        }

        // Helper functions for VIN request details modal
        function copyRequestId(requestId) {
            navigator.clipboard.writeText(requestId).then(() => {
                EnhancedUI.showToast('Request ID copied to clipboard', 'success');
            }).catch(() => {
                EnhancedUI.showToast('Failed to copy request ID', 'error');
            });
        }

        function exportRequestData(requestId) {
            // Get request data and export as JSON
            AdminManager.getRequests().then(requests => {
                const request = requests.find(r => r.requestId === requestId);
                if (request) {
                    const dataStr = JSON.stringify(request, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `vin-request-${requestId}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    EnhancedUI.showToast('Request data exported successfully', 'success');
                }
            }).catch(error => {
                EnhancedUI.showToast('Failed to export request data', 'error');
            });
        }

        async function downloadPDF(requestId) {
            try {
                // Get authentication token
                const token = TokenManager.getAccessToken();
                if (!token) {
                    EnhancedUI.showToast('Authentication required to download PDF', 'error');
                    return;
                }

                // Fetch PDF with authentication
                const response = await fetch(`http://localhost:3001/api/admin/download-pdf/${requestId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Get the PDF blob
                const blob = await response.blob();
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `VINaris_Report_${requestId}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up the object URL
                URL.revokeObjectURL(url);
                
                EnhancedUI.showToast('PDF download started', 'success');

            } catch (error) {
                console.error('Error downloading PDF:', error);
                EnhancedUI.showToast('Failed to download PDF: ' + error.message, 'error');
            }
        }

        async function viewUserDetails(userId) {
            try {
                const response = await AdminManager.getUserDetails(userId);
                if (!response) {
                    EnhancedUI.showToast('User not found', 'error');
                    return;
                }

                const { user, statistics, recentRequests, creditTransactions, recentActivities, paymentRequests } = response;

                const userDetails = `
                    <div class="compact-user-details">
                        <!-- Compact Header -->
                        <div class="compact-header">
                            <div class="user-basic-info">
                                <div class="user-avatar-small">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="user-details-text">
                                    <h3>${user.name}</h3>
                                    <p>${user.email}</p>
                                    <div class="user-status-badges">
                                        <span class="badge ${user.type === 'admin' ? 'badge-warning' : 'badge-info'}">${user.type === 'admin' ? 'Admin' : 'User'}</span>
                                        <span class="badge ${user.status === 'active' ? 'badge-success' : user.status === 'suspended' ? 'badge-warning' : 'badge-danger'}">${user.status || 'active'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="user-stats-compact">
                                <div class="stat-item">
                                    <span class="stat-number">${statistics.totalRequests}</span>
                                    <span class="stat-label">Requests</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${statistics.completedRequests}</span>
                                    <span class="stat-label">Completed</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${user.credits}</span>
                                    <span class="stat-label">Credits</span>
                                </div>
                            </div>
                        </div>

                        <!-- Compact Content -->
                        <div class="compact-content">
                            <div class="info-section">
                                <h4><i class="fas fa-info-circle"></i> Account Details</h4>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="label">User ID:</span>
                                        <span class="value">${user.uniqueId}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Company:</span>
                                        <span class="value">${user.company || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Phone:</span>
                                        <span class="value">${user.phone || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Registered:</span>
                                        <span class="value">${formatDate(user.createdAt)}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Last Login:</span>
                                        <span class="value">${user.lastLoginAt ? formatDate(user.lastLoginAt) : 'Never'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Success Rate:</span>
                                        <span class="value success-rate">${statistics.successRate}%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="activity-section-compact">
                                <h4><i class="fas fa-history"></i> Recent Activity (${recentRequests.length + recentActivities.length})</h4>
                                <div class="compact-activity-list">
                                    ${recentRequests.slice(0, 3).map(request => `
                                        <div class="activity-item-compact">
                                            <i class="fas fa-car text-primary"></i>
                                            <span class="activity-text">${request.request_id}</span>
                                            <span class="status-badge-small ${request.status}">${getStatusText(request.status)}</span>
                                        </div>
                                    `).join('')}
                                    ${recentActivities.slice(0, 2).map(activity => `
                                        <div class="activity-item-compact">
                                            <i class="fas fa-${getActivityIcon(activity.activity_type)} text-info"></i>
                                            <span class="activity-text">${activity.activity_type}</span>
                                            <span class="activity-time">${formatDate(activity.created_at)}</span>
                                        </div>
                                    `).join('')}
                                    ${(recentRequests.length + recentActivities.length) === 0 ? '<div class="no-activity">No recent activity</div>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                showModal('User Details', userDetails, [
                    {
                        text: 'Manage Credits',
                        class: 'btn-warning',
                        onclick: `closeModal(); manageUserCredits('${userId}');`,
                        icon: 'fas fa-coins'
                    }
                ], { 
                    icon: 'user', 
                    subtitle: 'User profile and activity overview',
                    width: '600px'
                });
            } catch (error) {
                console.error('Error loading user details:', error);
                EnhancedUI.showToast('Failed to load user details', 'error');
            }
        }

        // Create User Modal Functions

        function showCreateUserModal() {
            console.log('showCreateUserModal called'); // Debug log
            
            const createUserForm = `
                <div class="compact-create-user">
                    <form id="createUserForm">
                        <!-- Login Information -->
                        <div class="form-section required-section">
                            <h4><i class="fas fa-key"></i> Login Information <span class="required-badge">Required</span></h4>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="userEmail">Email Address *</label>
                                    <input type="email" id="userEmail" name="email" required 
                                           placeholder="Enter email address"
                                           oninput="validateField(this, 'email')">
                                    <div class="field-error" id="email-error"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="userPassword">Password *</label>
                                    <div class="password-input-group">
                                        <input type="password" id="userPassword" name="password" required 
                                               placeholder="Enter password"
                                               oninput="validatePassword(this)">
                                        <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="password-strength" id="password-strength">
                                        <div class="strength-bar">
                                            <div class="strength-fill" id="strength-fill"></div>
                                        </div>
                                        <div class="strength-text" id="strength-text">Enter a password</div>
                                    </div>
                                    <div class="field-error" id="password-error"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Type Selection -->
                        <div class="form-section">
                            <h4><i class="fas fa-user-tag"></i> Account Type</h4>
                            <div class="account-type-selection">
                                <div class="type-option" data-type="user" onclick="selectUserType('user')">
                                    <div class="type-icon">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <span>Regular User</span>
                                </div>
                                
                                <div class="type-option" data-type="admin" onclick="selectUserType('admin')">
                                    <div class="type-icon admin">
                                        <i class="fas fa-crown"></i>
                                    </div>
                                    <span>Administrator</span>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information (Collapsible) -->
                        <div class="form-section collapsible-section">
                            <div class="section-header" onclick="toggleCollapsibleSection('optional-info')">
                                <h4><i class="fas fa-user"></i> Additional Information <span class="optional-badge">Optional</span></h4>
                                <i class="fas fa-chevron-down section-toggle" id="optional-info-toggle"></i>
                            </div>
                            
                            <div class="collapsible-content" id="optional-info" style="display: none;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="userName">Full Name</label>
                                        <input type="text" id="userName" name="name" 
                                               placeholder="Enter full name">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="userCredits">Initial Credits</label>
                                        <input type="number" id="userCredits" name="credits" min="0" value="3"
                                               placeholder="Enter credits amount"
                                               oninput="validateCredits(this)">
                                        <small class="field-hint">Default: <span id="credits-default">3</span> credits</small>
                                    </div>
                                </div>
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="userCompany">Company</label>
                                        <input type="text" id="userCompany" name="company" 
                                               placeholder="Company name">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="userPhone">Phone</label>
                                        <input type="tel" id="userPhone" name="phone" 
                                               placeholder="Phone number">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            `;

            const buttons = [
                {
                    text: 'Cancel',
                    class: 'btn-secondary',
                    onclick: 'closeModal();'
                },
                {
                    text: 'Create User',
                    class: 'btn-success',
                    onclick: 'createUser();',
                    icon: 'fas fa-user-plus'
                }
            ];

            console.log('Buttons array:', buttons); // Debug log
            console.log('Calling showModal...'); // Debug log

            showModal('Create New User', createUserForm, buttons, { 
                icon: 'user-plus', 
                subtitle: 'Add a new user or administrator to the system',
                width: '700px'
            });

            console.log('showModal called'); // Debug log

            // Initialize form
            initializeCreateUserForm();
        }

        // Create User Form Management
        let selectedUserType = '';

        function initializeCreateUserForm() {
            selectedUserType = '';
            updateCreditsDefault();
            // Set default user type
            selectUserType('user');
        }

        function toggleCollapsibleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.classList.remove('fa-chevron-down');
                toggle.classList.add('fa-chevron-up');
            } else {
                content.style.display = 'none';
                toggle.classList.remove('fa-chevron-up');
                toggle.classList.add('fa-chevron-down');
            }
        }

        function validateForm() {
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;

            let isValid = true;

            // Validate email (required)
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email) {
                showFieldError('email-error', 'Email is required');
                isValid = false;
            } else if (!emailRegex.test(email)) {
                showFieldError('email-error', 'Please enter a valid email address');
                isValid = false;
            } else {
                hideFieldError('email-error');
            }

            // Validate password (required)
            if (!password) {
                showFieldError('password-error', 'Password is required');
                isValid = false;
            } else if (password.length < 8) {
                showFieldError('password-error', 'Password must be at least 8 characters long');
                isValid = false;
            } else {
                hideFieldError('password-error');
            }

            // Set default user type if not selected
            if (!selectedUserType) {
                selectedUserType = 'user'; // Default to regular user
            }

            return isValid;
        }

        function validateField(input, fieldType) {
            const value = input.value.trim();
            const errorId = fieldType + '-error';

            switch (fieldType) {
                case 'name':
                    if (value) hideFieldError(errorId);
                    break;
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (value && emailRegex.test(value)) {
                        hideFieldError(errorId);
                    }
                    break;
            }
        }

        function validatePassword(input) {
            const password = input.value;
            const strengthFill = document.getElementById('strength-fill');
            const strengthText = document.getElementById('strength-text');

            let strength = 0;
            let strengthLabel = '';

            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            const percentage = (strength / 5) * 100;
            strengthFill.style.width = percentage + '%';

            switch (strength) {
                case 0:
                case 1:
                    strengthLabel = 'Very Weak';
                    strengthFill.style.background = '#dc3545';
                    break;
                case 2:
                    strengthLabel = 'Weak';
                    strengthFill.style.background = '#fd7e14';
                    break;
                case 3:
                    strengthLabel = 'Fair';
                    strengthFill.style.background = '#ffc107';
                    break;
                case 4:
                    strengthLabel = 'Good';
                    strengthFill.style.background = '#20c997';
                    break;
                case 5:
                    strengthLabel = 'Strong';
                    strengthFill.style.background = '#28a745';
                    break;
            }

            strengthText.textContent = strengthLabel;
        }

        function selectUserType(type) {
            selectedUserType = type;
            
            // Update visual selection
            document.querySelectorAll('.type-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.type === type);
            });

            // Update credits default
            updateCreditsDefault();
        }

        function updateCreditsDefault() {
            const creditsDefault = document.getElementById('credits-default');
            const userCredits = document.getElementById('userCredits');
            
            if (creditsDefault) {
                creditsDefault.textContent = selectedUserType === 'admin' ? '999' : '3';
            }
            
            if (userCredits && !userCredits.value) {
                userCredits.placeholder = `Default: ${selectedUserType === 'admin' ? '999' : '3'} credits`;
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggle = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                toggle.classList.remove('fa-eye');
                toggle.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                toggle.classList.remove('fa-eye-slash');
                toggle.classList.add('fa-eye');
            }
        }

        function updateReviewSummary() {
            document.getElementById('review-name').textContent = document.getElementById('userName').value || 'Not provided';
            document.getElementById('review-email').textContent = document.getElementById('userEmail').value || 'Not provided';
            document.getElementById('review-company').textContent = document.getElementById('userCompany').value || 'Not provided';
            document.getElementById('review-phone').textContent = document.getElementById('userPhone').value || 'Not provided';
            document.getElementById('review-type').textContent = selectedUserType === 'admin' ? 'Administrator' : 'Regular User';
            
            const credits = document.getElementById('userCredits').value;
            document.getElementById('review-credits').textContent = credits || (selectedUserType === 'admin' ? '999 (default)' : '3 (default)');
        }

        function showFieldError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function hideFieldError(errorId) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        async function createUser() {
            try {
                // Validate form
                if (!validateForm()) {
                    return;
                }

                const userData = {
                    name: document.getElementById('userName').value.trim() || 'User', // Default name if not provided
                    email: document.getElementById('userEmail').value.trim(),
                    password: document.getElementById('userPassword').value,
                    user_type: selectedUserType || 'user', // Default to regular user
                    credits: document.getElementById('userCredits').value ? parseInt(document.getElementById('userCredits').value) : 3,
                    company: document.getElementById('userCompany').value.trim() || '',
                    phone: document.getElementById('userPhone').value.trim() || ''
                };

                // Show loading state
                const createBtn = document.querySelector('.btn-success');
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                }

                const response = await AdminManager.createUser(userData);
                
                if (response && response.success) {
                    EnhancedUI.showToast('User created successfully!', 'success');
                    closeModal();
                    loadUsers(); // Refresh users list
                } else {
                    EnhancedUI.showToast('Failed to create user', 'error');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                EnhancedUI.showToast('Failed to create user: ' + (error.message || 'Unknown error'), 'error');
            } finally {
                // Reset button state
                const createBtn = document.querySelector('.btn-success');
                if (createBtn) {
                    createBtn.disabled = false;
                    createBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create User';
                }
            }
        }

        function saveSettings() {
            if (typeof VinDatabase !== 'undefined') {
                const settings = {
                    defaultCredits: parseInt(document.getElementById('defaultCredits').value),
                    autoProcessing: document.getElementById('autoProcessing').checked,
                    emailNotifications: document.getElementById('emailNotifications').checked
                };

                VinDatabase.set(VinDatabase.ADMIN_SETTINGS_KEY, settings);
                EnhancedUI.showToast('Settings saved successfully', 'success');
            }
        }

        // Utility functions
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pending',
                'processing': 'Processing',
                'processed': 'Processed',
                'completed': 'Completed',
                'delivered': 'Delivered',
                'rejected': 'Rejected',
                'cancelled': 'Cancelled'
            };
            return statusMap[status] || status;
        }

        function formatDate(timestamp) {
            if (typeof EnhancedUI !== 'undefined') {
                return EnhancedUI.formatDate(timestamp);
            }
            return new Date(timestamp).toLocaleDateString();
        }

        function refreshCurrentSection() {
            loadSectionData(currentSection);
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                if (currentSection === 'dashboard' || currentSection === 'vin-requests') {
                    refreshCurrentSection();
                }
            }, 30000); // Refresh every 30 seconds
        }

        // Simple modal system
        function showModal(title, content, buttons = [], options = {}) {
            console.log('showModal called with:', { title, buttons, options }); // Debug log
            
            // Remove existing modal
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }

            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(4px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
                padding: 20px;
            `;

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                background: var(--panel);
                border: 1px solid var(--border);
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                max-width: ${options.width || '600px'};
                max-height: 95vh;
                width: 100%;
                overflow: hidden;
                transform: scale(0.9) translateY(20px);
                transition: transform 0.3s ease;
                position: relative;
                display: flex;
                flex-direction: column;
            `;

            // Enhanced header with gradient
            const headerStyle = `
                background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
                color: white;
                padding: 20px 24px;
                border-bottom: 1px solid var(--border);
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: relative;
                overflow: hidden;
            `;

            // Decorative elements
            const decorativeElements = `
                <div style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); pointer-events: none;"></div>
                <div style="position: absolute; top: 10px; right: 10px; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;"></div>
            `;

            console.log('Generating buttons, buttons.length:', buttons.length); // Debug log
            
            const buttonHtml = buttons.length > 0 ? buttons.map(btn => {
                // Fix onclick attribute by replacing double quotes with single quotes
                const fixedOnclick = btn.onclick.replace(/"/g, "'");
                return `
                <button class="btn ${btn.class || 'btn-primary'}" onclick="${fixedOnclick}" style="
                    min-width: 100px;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-weight: 500;
                    transition: all 0.2s ease;
                    border: none;
                    cursor: pointer;
                    ${btn.class === 'btn-secondary' ? 'background: linear-gradient(135deg, #6c757d, #5a6268); color: white;' : ''}
                    ${btn.class === 'btn-danger' ? 'background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;' : ''}
                    ${btn.class === 'btn-success' ? 'background: linear-gradient(135deg, #27ae60, #229954); color: white;' : ''}
                    ${btn.class === 'btn-warning' ? 'background: linear-gradient(135deg, #f39c12, #e67e22); color: white;' : ''}
                    ${btn.class === 'btn-primary' ? 'background: linear-gradient(135deg, #007bff, #0056b3); color: white;' : ''}
                " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    ${btn.icon ? `<i class="${btn.icon}" style="margin-right: 8px;"></i>` : ''}
                    ${btn.text}
                </button>
            `;
            }).join('') : '';

            console.log('Generated buttonHtml:', buttonHtml); // Debug log

            modal.innerHTML = `
                ${options.hideHeader ? '' : `
                <div style="${headerStyle}">
                    ${decorativeElements}
                    <div style="position: relative; z-index: 1;">
                        <h3 style="margin: 0; font-size: 20px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-${options.icon || 'info-circle'}" style="opacity: 0.9;"></i>
                            ${title}
                        </h3>
                        ${options.subtitle ? `<p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">${options.subtitle}</p>` : ''}
                    </div>
                    <button class="modal-close-btn" onclick="closeModal()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        position: relative;
                        z-index: 1;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        <i class="fas fa-times" style="font-size: 14px;"></i>
                    </button>
                </div>
                `}
                <div style="padding: 16px; flex: 1; overflow-y: auto; min-height: 0;">
                    ${content}
                </div>
                ${buttons.length > 0 ? `
                    <div style="
                        padding: 20px 24px;
                        border-top: 1px solid var(--border);
                        background: var(--panel2);
                        display: flex;
                        gap: 12px;
                        justify-content: ${options.buttonAlign || 'flex-end'};
                        flex-wrap: wrap;
                    ">
                        ${buttonHtml}
                    </div>
                ` : ''}
            `;

            console.log('Modal HTML generated, buttons.length:', buttons.length); // Debug log

            modalOverlay.appendChild(modal);
            document.body.appendChild(modalOverlay);

            // Animate in
            requestAnimationFrame(() => {
                modalOverlay.style.opacity = '1';
                modal.style.transform = 'scale(1) translateY(0)';
            });

            // Close on overlay click
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });

            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);

            // Focus management
            const firstInput = modal.querySelector('input, select, textarea, button');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                const modalContent = modal.querySelector('.modal');
                if (modalContent) {
                    // Animate out
                    modalContent.style.transform = 'scale(0.9) translateY(20px)';
                    modal.style.opacity = '0';
                    
                    // Remove after animation
                    setTimeout(() => {
                        modal.remove();
                    }, 300);
                } else {
                    modal.remove();
                }
            }
        }

        // Helper functions for bulk operations
        function selectAllUsers() {
            document.querySelectorAll('input[type="checkbox"][id^="user_"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        function deselectAllUsers() {
            document.querySelectorAll('input[type="checkbox"][id^="user_"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        function addCreditsToSelectedUsers() {
            const selectedUserIds = Array.from(
                document.querySelectorAll('input[type="checkbox"][id^="user_"]:checked')
            ).map(checkbox => checkbox.value);
            
            if (selectedUserIds.length === 0) {
                EnhancedUI.showToast('No users selected', 'warning');
                return;
            }
            
            const amount = parseInt(document.getElementById('bulkAmount').value);
            const reason = document.getElementById('bulkReason').value || 'Selected users credit adjustment';
            const adminId = EnhancedAuth?.getCurrentUser()?.id || 'admin';
            let successCount = 0;
            
            if (typeof CreditManager !== 'undefined') {
                selectedUserIds.forEach(userId => {
                    try {
                        CreditManager.addCredits(userId, amount, reason, adminId);
                        successCount++;
                    } catch (error) {
                        console.error(`Failed to add credits to user ${userId}: ${error.message}`);
                    }
                });
                
                EnhancedUI.showToast(`Added ${amount} credits to ${successCount} users`, 'success');
                document.getElementById('bulkAmount').value = '';
                document.getElementById('bulkReason').value = '';
                loadUserCredits();
                loadTransactionHistory();
            }
        }
        
        // Additional admin functions
        
        
        
        async function markAsPending(requestId) {
            try {
                const success = await AdminManager.updateRequestStatus(requestId, 'pending');
                if (success) {
                    EnhancedUI.showToast('Request marked as pending', 'success');
                    loadVinRequests();
                    loadRecentRequests();
                } else {
                    EnhancedUI.showToast('Failed to update request status', 'error');
                }
            } catch (error) {
                console.error('Error updating request status:', error);
                EnhancedUI.showToast('Error updating request status: ' + error.message, 'error');
            }
        }
        
        
        async function manageUserCredits(userId) {
            const newCredits = prompt('Enter new credit amount:');
            if (newCredits !== null && !isNaN(newCredits)) {
                try {
                    const success = await AdminManager.updateUserCredits(userId, parseInt(newCredits));
                    if (success) {
                        EnhancedUI.showToast('User credits updated successfully!', 'success');
                        loadUsers();
                    } else {
                        EnhancedUI.showToast('Failed to update user credits', 'error');
                    }
                } catch (error) {
                    console.error('Error updating user credits:', error);
                    EnhancedUI.showToast('Failed to update user credits', 'error');
                }
            }
        }

        async function editUser(userId) {
            try {
                const users = await AdminManager.getUsers();
                const user = users.find(u => u.id == userId);
                
                if (!user) {
                    EnhancedUI.showToast('User not found', 'error');
                    return;
                }
                
                const newName = prompt('Enter new name:', user.name);
                if (newName === null) return;

                const newEmail = prompt('Enter new email:', user.email);
                if (newEmail === null) return;

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(newEmail)) {
                    EnhancedUI.showToast('Please enter a valid email address', 'error');
                    return;
                }

                const success = await AdminManager.updateUser(userId, { name: newName, email: newEmail });
                if (success) {
                    EnhancedUI.showToast('User updated successfully!', 'success');
                    loadUsers();
                } else {
                    EnhancedUI.showToast('Failed to update user', 'error');
                }
            } catch (error) {
                console.error('Error editing user:', error);
                EnhancedUI.showToast('Failed to edit user', 'error');
            }
        }

        async function viewUserActivity(userId) {
            try {
                const activities = await AdminManager.getUserActivities(userId);
                
                let activityHtml = '<div style="max-height: 400px; overflow-y: auto;">';
                if (activities.length === 0) {
                    activityHtml += '<p style="text-align: center; color: var(--muted); padding: 20px;">No activity found for this user</p>';
                } else {
                    activityHtml += activities.map(activity => `
                        <div style="padding: 10px; border-bottom: 1px solid var(--border);">
                            <div style="font-weight: bold; color: var(--primary);">${activity.action}</div>
                            <div style="color: var(--muted); font-size: 0.9em;">${activity.description || 'No description'}</div>
                            <div style="color: var(--muted); font-size: 0.8em;">${EnhancedUI.formatDate(activity.created_at)}</div>
                        </div>
                    `).join('');
                }
                activityHtml += '</div>';

                showModal('User Activity', activityHtml);
            } catch (error) {
                console.error('Error loading user activity:', error);
                EnhancedUI.showToast('Failed to load user activity', 'error');
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            try {
                const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
                const confirmMessage = `Are you sure you want to ${newStatus === 'active' ? 'activate' : 'suspend'} this user?`;
                
                if (!confirm(confirmMessage)) return;

                const success = await AdminManager.updateUserStatus(userId, newStatus);
                    if (success) {
                    EnhancedUI.showToast(`User ${newStatus === 'active' ? 'activated' : 'suspended'} successfully!`, 'success');
                        loadUsers();
                    } else {
                    EnhancedUI.showToast('Failed to update user status', 'error');
                    }
                } catch (error) {
                console.error('Error toggling user status:', error);
                EnhancedUI.showToast('Failed to update user status', 'error');
            }
        }

        function showUserRegistrationDetails(userId, userName, joinDate) {
            try {
                const registrationDate = new Date(joinDate);
                const now = new Date();
                const daysSinceRegistration = Math.floor((now - registrationDate) / (1000 * 60 * 60 * 24));
                
                let timeSinceRegistration;
                if (daysSinceRegistration === 0) {
                    timeSinceRegistration = 'Today';
                } else if (daysSinceRegistration === 1) {
                    timeSinceRegistration = '1 day ago';
                } else if (daysSinceRegistration < 7) {
                    timeSinceRegistration = `${daysSinceRegistration} days ago`;
                } else if (daysSinceRegistration < 30) {
                    const weeks = Math.floor(daysSinceRegistration / 7);
                    timeSinceRegistration = `${weeks} week${weeks > 1 ? 's' : ''} ago`;
                } else if (daysSinceRegistration < 365) {
                    const months = Math.floor(daysSinceRegistration / 30);
                    timeSinceRegistration = `${months} month${months > 1 ? 's' : ''} ago`;
                } else {
                    const years = Math.floor(daysSinceRegistration / 365);
                    timeSinceRegistration = `${years} year${years > 1 ? 's' : ''} ago`;
                }

                const registrationDetails = `
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; color: var(--primary); margin-bottom: 10px;">
                                <i class="fas fa-calendar-plus"></i>
                            </div>
                            <h3 style="margin: 0; color: var(--text-primary);">Registration Details</h3>
                            <p style="margin: 5px 0 0 0; color: var(--muted);">${userName}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="padding: 15px; background: var(--panel2); border-radius: 8px; border-left: 4px solid var(--primary);">
                                <div style="font-weight: bold; color: var(--primary); margin-bottom: 5px;">Registration Date</div>
                                <div style="color: var(--text-primary);">${formatDate(joinDate)}</div>
                            </div>
                            <div style="padding: 15px; background: var(--panel2); border-radius: 8px; border-left: 4px solid var(--success);">
                                <div style="font-weight: bold; color: var(--success); margin-bottom: 5px;">Time Since Registration</div>
                                <div style="color: var(--text-primary);">${timeSinceRegistration}</div>
                            </div>
                        </div>
                        
                        <div style="padding: 15px; background: var(--panel2); border-radius: 8px; border-left: 4px solid var(--info);">
                            <div style="font-weight: bold; color: var(--info); margin-bottom: 10px;">Registration Timeline</div>
                            <div style="color: var(--text-primary); font-size: 0.9em;">
                                 User registered: <strong>${daysSinceRegistration} days ago</strong><br>
                                 Account age: <strong>${Math.floor(daysSinceRegistration / 30)} months, ${daysSinceRegistration % 30} days</strong><br>
                                 Registration day: <strong>${registrationDate.toLocaleDateString('en-US', { weekday: 'long' })}</strong>
                            </div>
                        </div>
                    </div>
                `;

                showModal('User Registration Details', registrationDetails);
            } catch (error) {
                console.error('Error showing registration details:', error);
                EnhancedUI.showToast('Failed to load registration details', 'error');
            }
        }
        
        // Helper functions
        
        
        function getActivityIcon(type) {
            const iconMap = {
                'login': 'sign-in-alt',
                'logout': 'sign-out-alt',
                'vin_check': 'search',
                'credit_add': 'plus',
                'credit_remove': 'minus',
                'request_processed': 'check',
                'request_rejected': 'times',
                'pdf_uploaded': 'file-pdf',
                'pdf_sent': 'paper-plane'
            };
            return iconMap[type] || 'circle';
        }
        
        function refreshCurrentSection() {
            // Refresh the current active section
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabId = activeTab.getAttribute('data-tab');
                switch(tabId) {
                    case 'requests':
                        loadVinRequests();
                        break;
                    case 'users':
                        loadUsers();
                        break;
                    case 'credits':
                        loadUserCredits();
                        break;
                    case 'activities':
                        loadActivities();
                        break;
                }
            }
        }
        
        // Add initializePage function for compatibility
        window.initializePage = function() {
            console.log('Page-specific initialization...');
            // Load all data
            loadRecentRequests();
            loadVinRequests();
            loadUsers();
        };

        // Logout function
        async function logout() {
            console.log('Logout function called');
            
            try {
                // Call API logout first
                const response = await fetch('../api.php/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                console.log('API logout response:', response.status);
            } catch (error) {
                console.log('API logout failed:', error);
            }
            
            // Clear EnhancedAuth session
            if (typeof EnhancedAuth !== 'undefined' && EnhancedAuth.logout) {
                // Don't call EnhancedAuth.logout() as it redirects
                // Just clear the token manually
                if (typeof TokenManager !== 'undefined') {
                    TokenManager.clearToken();
                }
            }
            
            // Clear all possible session data
            localStorage.removeItem('vinaris_user');
            localStorage.removeItem('vinaris_session');
            localStorage.removeItem('vinaris_token');
            sessionStorage.clear();
            
            console.log('All session data cleared');
            
            // Redirect to login immediately
            window.location.href = '../Login/login.html';
        }

        // Make logout function globally available
        window.logout = logout;
    </script>
</body>
</html>
