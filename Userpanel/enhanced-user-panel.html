<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VINaris User Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-gradient: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            --panel: #1a1a1a;
            --panel2: #2a2a2a;
            --panel-hover: #222222;
            --muted: #888888;
            --txt: #ffffff;
            --txt-light: #e4e4e7;
            --accent: #e60000;
            --accent-light: #ef4444;
            --accent-hover: #cc0000;
            --success: #22c55e;
            --success-hover: #16a34a;
            --info: #3b82f6;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.6);
            --card-radius: 12px;
            --border: #2a2a30;
            --border-light: #34343c;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Inter", "Segoe UI", Arial, sans-serif;
            background: 
                radial-gradient(1400px 800px at 90% -20%, rgba(230, 0, 0, 0.03), transparent 70%),
                radial-gradient(800px 600px at 10% 120%, rgba(34, 197, 94, 0.02), transparent 50%),
                var(--bg);
            color: var(--txt);
            -webkit-font-smoothing: antialiased;
            line-height: 1.6;
            padding: 24px 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: var(--panel);
            border-radius: var(--card-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--border-light);
        }

        .card:hover::before {
            opacity: 1;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            padding: 20px 24px;
            background: var(--panel);
            border-radius: var(--card-radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 14px;
            color: var(--muted);
            margin: 0;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .header button {
            padding: 10px 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .header button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s ease;
        }

        .header button:hover::before {
            left: 100%;
        }

        .btn-profile {
            background: var(--accent);
            color: #fff;
            border: 1px solid var(--accent);
        }

        .btn-logout {
            background: #dc2626;
            color: #fff;
            border: 1px solid #dc2626;
        }

        .btn-balance {
            background: var(--success);
            color: #fff;
            border: 1px solid var(--success);
        }

        .header button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .btn-profile:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-logout:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        .btn-balance:hover {
            background: var(--success-hover);
            border-color: var(--success-hover);
        }

        /* Enhanced Button Styles */
        .btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn:hover::after {
            width: 300px;
            height: 300px;
        }

        /* Enhanced Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }

        /* Collapsible Sections */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .collapsible-header:hover {
            color: var(--accent);
        }

        .collapsible-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-toggle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--panel2);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 12px;
            color: var(--txt);
        }

        .collapsible-toggle:hover {
            background: var(--accent);
            color: white;
            transform: scale(1.1);
        }

        .collapsible-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }

        /* Enhanced Profile Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--panel);
            border-radius: var(--card-radius);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            animation: slideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--panel2);
            border-radius: var(--card-radius) var(--card-radius) 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--txt);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: var(--accent);
            background: rgba(230, 0, 0, 0.1);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: var(--panel2);
            border-radius: 0 0 var(--card-radius) var(--card-radius);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Profile Edit Forms */
        .profile-edit-container,
        .password-change-container {
            max-width: 550px;
            margin: 0 auto;
        }
        
        .edit-header,
        .password-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 10px rgba(230, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .edit-header::before,
        .password-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .edit-header-left,
        .password-header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }
        
        .edit-header h3,
        .password-header h3 {
            color: white;
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .password-header p {
            color: rgba(255, 255, 255, 0.9);
            margin: 4px 0 0 0;
            font-size: 14px;
            font-weight: 500;
        }
        
        .profile-edit-form,
        .password-change-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--txt-light);
            font-size: 13px;
        }
        
        .form-group input,
        .form-group textarea {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--panel2);
            color: var(--txt);
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(230, 0, 0, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .password-hint {
            color: var(--muted);
            font-size: 12px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }

        /* Enhanced Metrics - Beautiful Cards */
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }

        .metric {
            background: var(--panel);
            border-radius: var(--card-radius);
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .metric:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--border-light);
        }

        .metric:hover::before {
            opacity: 1;
        }

        .metric.credits::before { 
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
        }
        .metric.sent::before { 
            background: linear-gradient(90deg, var(--info), #60a5fa);
        }
        .metric.pending::before { 
            background: linear-gradient(90deg, var(--warning), #fbbf24);
        }
        .metric.processed::before { 
            background: linear-gradient(90deg, var(--success), #4ade80);
        }

        .metric.credits { 
            border-left: 4px solid var(--accent);
        }
        .metric.sent { 
            border-left: 4px solid var(--info);
        }
        .metric.pending { 
            border-left: 4px solid var(--warning);
        }
        .metric.processed { 
            border-left: 4px solid var(--success);
        }

        .metric .left { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            flex: 1;
        }

        .metric .label { 
            font-size: 13px; 
            color: var(--txt-light); 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            font-weight: 600;
            margin-bottom: 4px;
        }

        .metric .value { 
            font-size: 32px; 
            font-weight: 700; 
            color: var(--txt);
            line-height: 1;
        }

        .metric .icon { 
            font-size: 32px; 
            opacity: 0.7;
        }



        /* VIN Input Section - Main Focus */
        .vin-section {
            background: var(--panel);
            border-radius: var(--card-radius);
            padding: 24px;
            border: 1px solid var(--border);
            margin: 24px 0;
            box-shadow: var(--shadow);
            overflow: hidden;
        }


        .vin-section h3 {
            margin: 0 0 24px 0;
            color: var(--accent);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .vin-section h3 i {
            color: var(--accent);
            font-size: 24px;
        }

        .vin-row {
            display: flex;
            gap: 16px;
            align-items: stretch;
            flex-wrap: wrap;
        }

        .vin-input-group {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .vin-row input[type="text"] {
            width: 100%;
            padding: 20px 24px;
            border-radius: 16px;
            border: 2px solid var(--border);
            background: var(--panel2);
            color: var(--txt);
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: var(--shadow);
        }

        .vin-row input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(230, 0, 0, 0.2), var(--shadow);
            transform: translateY(-2px);
            background: var(--panel-hover);
        }

        .vin-row input[type="text"]::placeholder {
            color: var(--muted);
            font-weight: 400;
            letter-spacing: 1px;
        }

        .vin-counter {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #00b3ff, #007bff);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            color: white;
            font-weight: 700;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 179, 255, 0.3);
        }

        .vin-row button {
            padding: 20px 32px;
            border-radius: 16px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 200px;
            justify-content: center;
        }

        .vin-row .send-btn {
            background: var(--accent);
            color: #fff;
            border: 1px solid var(--accent);
        }

        .vin-row .send-btn:hover {
            background: var(--accent-light);
            transform: translateY(-2px);
        }

        .vin-row .send-btn:active {
            transform: translateY(-2px);
        }

        .vin-row .send-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            border-color: #666;
        }

        /* Table Container - Fixed Scroll Issues */
        .table-container {
            background: var(--panel);
            border-radius: var(--card-radius);
            border: 1px solid var(--border);
            margin: 24px 0;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .payment-form {
            padding: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group input,
        .form-group textarea {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--panel);
            color: var(--text);
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        
        .status-badge.info {
            background: rgba(13, 202, 240, 0.2);
            color: #0dcaf0;
        }
        
        .status-badge.success {
            background: rgba(25, 135, 84, 0.2);
            color: #198754;
        }
        
        .status-badge.danger {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }
        
        .status-badge.muted {
            background: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }
        
        /* Profile Page Styles */
        .profile-page {
            background: var(--panel);
            border-radius: var(--card-radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .profile-page-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px 24px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
        }

        .profile-page-header h2 {
            margin: 0;
            color: var(--text);
            font-size: 24px;
            font-weight: 600;
        }

        .profile-page-header .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: var(--text);
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-page-header .btn:hover {
            background: linear-gradient(135deg, var(--accent), #0088d1);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,179,255,0.3);
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(10px);
            }
        }
        
        .modal-content {
            background: var(--panel);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--text);
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--muted);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--panel2);
            color: var(--text);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Profile Modal Specific Styles */
        .profile-modal {
            border: none;
            box-shadow: 0 25px 80px rgba(0,0,0,0.6);
        }

        .profile-modal-body {
            padding: 16px 20px;
        }

        .profile-modal .modal-header {
            padding: 16px 20px;
            border-bottom: none;
        }

        .profile-modal .modal-footer {
            padding: 12px 20px;
            border-top: none;
        }

        /* Credit Packages */
        .credit-packages {
            margin-bottom: 24px;
        }

        .credit-packages h4 {
            margin: 0 0 16px 0;
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
        }

        .package-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .package-option {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: var(--panel);
        }

        .package-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .package-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(102, 126, 234, 0.1) 100%);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            position: relative;
        }

        .package-option.selected::before {
            content: '✓';
            position: absolute;
            top: -8px;
            left: -8px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            z-index: 10;
            animation: checkmarkPulse 0.6s ease-out;
        }

        @keyframes checkmarkPulse {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .package-option.popular {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.05);
        }

        .package-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .package-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .package-header h5 {
            margin: 0;
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
        }

        .package-price {
            color: var(--primary);
            font-size: 18px;
            font-weight: bold;
        }

        .package-credits {
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .package-description {
            color: var(--muted);
            font-size: 12px;
            line-height: 1.3;
        }



        /* Bank Information Section */
        .bank-info-section {
            background: var(--panel2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .bank-info-section h4 {
            margin: 0 0 16px 0;
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
        }

        .bank-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bank-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .bank-item label {
            min-width: 80px;
            color: var(--muted);
            font-size: 14px;
            font-weight: 500;
        }

        .bank-item span {
            flex: 1;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            font-family: monospace;
            background: var(--panel);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .bank-item.price-item {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(102, 126, 234, 0.05) 100%);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .bank-item.price-item label {
            font-weight: 700;
            color: var(--primary);
            font-size: 15px;
        }

        .price-amount {
            font-family: 'Courier New', monospace !important;
            font-size: 18px !important;
            font-weight: bold !important;
            color: var(--primary) !important;
            background: rgba(102, 126, 234, 0.1) !important;
            padding: 8px 12px !important;
            border: 2px solid var(--primary) !important;
            border-radius: 6px !important;
        }

        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: var(--primary-dark, #4c63d2);
            transform: translateY(-1px);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        /* Payment Warning */
        .payment-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: warningPulse 2s ease-in-out infinite;
        }

        @keyframes warningPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(255, 193, 7, 0.1); }
        }

        .warning-icon {
            color: #856404;
            font-size: 24px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .warning-content {
            flex: 1;
        }

        .warning-content h5 {
            margin: 0 0 8px 0;
            color: #856404;
            font-size: 16px;
            font-weight: 700;
        }

        .warning-content p {
            margin: 0 0 8px 0;
            color: #856404;
            font-size: 14px;
            line-height: 1.5;
        }

        .warning-content p:last-child {
            margin-bottom: 0;
        }

        .warning-content strong {
            color: #721c24;
            font-weight: 700;
        }

        .table-header {
            background: linear-gradient(135deg, rgba(0, 179, 255, 0.1), rgba(0, 123, 255, 0.05));
            padding: 20px 28px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .table-header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00b3ff, transparent);
        }

        .table-header h3 {
            margin: 0;
            color: var(--info);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-wrap {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Custom scrollbar */
        .table-wrap::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-wrap::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .table-wrap::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }

        .table-wrap::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .table thead th {
            background: linear-gradient(135deg, rgba(0, 179, 255, 0.12), rgba(0, 123, 255, 0.06));
            color: rgba(255,255,255,0.9);
            font-weight: 700;
            padding: 20px 24px;
            text-align: left;
            font-size: 13px;
            border-bottom: 2px solid rgba(0, 179, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            position: relative;
        }

        .table thead th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0, 179, 255, 0.5), transparent);
        }

        .table tbody tr {
            background: transparent;
            transition: all 0.3s;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .table tbody tr:hover {
            background: linear-gradient(135deg, rgba(0, 179, 255, 0.08), rgba(0, 123, 255, 0.03));
        }

        .table tbody tr:hover td {
            color: rgba(255,255,255,0.95);
        }

        .table td {
            padding: 20px 24px;
            font-size: 14px;
            color: var(--txt);
            vertical-align: middle;
            transition: all 0.3s ease;
        }

        /* Status Pills */
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 12px;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pill .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .pill.pending {
            background: linear-gradient(135deg, #ffb86b, #ff9500);
            box-shadow: 0 3px 10px rgba(255,184,107,0.3);
        }
        .pill.pending .dot { background: #ff9500; }

        .pill.processed {
            background: linear-gradient(135deg, #2ecc71, #22b366);
            box-shadow: 0 3px 10px rgba(46,204,113,0.3);
        }
        .pill.processed .dot { background: #16a34a; }

        .pill.delivered {
            background: linear-gradient(135deg, #2ecc71, #22b366);
            box-shadow: 0 3px 10px rgba(46,204,113,0.3);
        }
        .pill.delivered .dot { background: #16a34a; }

        .pill.rejected {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 3px 10px rgba(231,76,60,0.3);
        }
        .pill.rejected .dot { background: #dc2626; }

        /* Controls */
        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin: 24px 0;
            padding: 20px 24px;
            background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
        }

        .controls input, .controls select {
            padding: 14px 18px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: var(--txt);
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .controls input:focus, .controls select:focus {
            outline: none;
            border-color: #00b3ff;
            box-shadow: 0 0 0 3px rgba(0, 179, 255, 0.1);
            background: rgba(255,255,255,0.08);
        }

        .controls input[type="search"] {
            min-width: 250px;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn.primary {
            background: var(--info);
            color: #fff;
        }

        .btn.primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .download-btn {
            background: linear-gradient(135deg, #ffd700, #ffb700);
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255,215,0,0.4);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Loading Animation */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 16px 12px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
                padding: 20px;
            }

            .header-controls {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }

            .header-controls button {
                flex: 1;
                min-width: 120px;
            }

            .vin-row {
                flex-direction: column;
                gap: 12px;
            }

            .vin-input-group {
                width: 100%;
            }

            .send-btn {
                width: 100%;
            }

            .metrics {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .controls input[type="search"] {
                min-width: auto;
                width: 100%;
            }

            .table-container {
                overflow-x: auto;
            }

            .table {
                min-width: 600px;
            }

            .profile-page {
                margin: 0;
                border-radius: 0;
                padding: 16px;
            }

            .profile-page-header {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            .modal-content {
                width: 95%;
                margin: 20px;
                max-height: 95vh;
            }
        }

        @media (max-width: 480px) {
            .metrics {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .metric .value {
                font-size: 28px;
            }

            .metric .icon {
                font-size: 36px;
            }

            .header-controls button {
                min-width: 100px;
                font-size: 12px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>👤 მომხმარებლის პანელი</h1>
                <p class="subtitle">მოგესალმებით, <span id="userNameHeader">მომხმარებელი</span>!</p>
            </div>
            <div class="header-controls">
                <button class="btn-balance" id="addBalanceBtn" onclick="openPaymentModal()">
                    <i class="fas fa-plus"></i> კრედიტები
                </button>
                <button class="btn-profile" id="profileBtn">
                    <i class="fas fa-user"></i> პროფილი
                </button>
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> გასვლა
                </button>
            </div>
        </div>

        <!-- Profile Page (Hidden by default) -->
        <div id="profilePage" class="profile-page" style="display: none;">
            <div class="profile-page-header">
                <button class="btn btn-secondary" onclick="hideProfilePage()">
                    <i class="fas fa-arrow-left"></i> უკან
                </button>
                <h2><i class="fas fa-user-circle"></i> მომხმარებლის პროფილი</h2>
            </div>
            <div id="profilePageContent">
                <!-- Profile content will be inserted here -->
            </div>
        </div>


        <!-- Enhanced VIN Input Section - Main Focus -->
        <div class="vin-section">
            <h3><i class="fas fa-car"></i> VIN კოდის შემოწმება</h3>
            <div class="vin-row">
                <div class="vin-input-group">
                    <input id="vinInput" type="text" placeholder="შეიყვანეთ 17-ნიშნა VIN კოდი" maxlength="17">
                    <div class="vin-counter">
                        <span id="vinCharCount">0</span>/17
                    </div>
                </div>
                <button id="sendVinBtn" class="send-btn" disabled>
                    <i class="fas fa-search"></i> შემოწმება (1 კრედიტი)
                </button>
            </div>
        </div>

        <!-- Enhanced Metrics -->
        <div class="metrics">
            <div class="metric credits">
                <div class="left">
                    <div class="label">კრედიტები</div>
                    <div id="userCredits" class="value">0</div>
                </div>
                <div class="icon">💳</div>
            </div>
            <div class="metric sent">
                <div class="left">
                    <div class="label">გაგზავნილი</div>
                    <div id="sentCount" class="value">0</div>
                </div>
                <div class="icon">📤</div>
            </div>
            <div class="metric pending">
                <div class="left">
                    <div class="label">დამუშავებაში</div>
                    <div id="pendingCount" class="value">0</div>
                </div>
                <div class="icon">⏳</div>
            </div>
            <div class="metric processed">
                <div class="left">
                    <div class="label">დამუშავებული</div>
                    <div id="processedCount" class="value">0</div>
                </div>
                <div class="icon">✅</div>
            </div>
        </div>

        <!-- Enhanced Controls -->
        <div class="controls">
            <input id="searchInput" type="search" placeholder="🔍 VIN-ით მოძებნა..." aria-label="Search VIN">
            <select id="statusFilter">
                <option value="all">ყველა სტატუსი</option>
                <option value="pending">დამუშავებაში</option>
                <option value="processed">დამუშავებული</option>
                <option value="delivered">გაგზავნილი</option>
                <option value="rejected">უარყოფილი</option>
            </select>
            <div style="margin-left: auto; display: flex; gap: 8px;">
                <button class="btn primary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> განახლება
                </button>
            </div>
        </div>

        <!-- Enhanced Table -->
        <div class="table-container">
            <div class="table-header">
                <h3><i class="fas fa-list"></i> VIN მოთხოვნების ისტორია</h3>
            </div>
            <div class="table-wrap">
                <table class="table" id="requestsTable">
                    <thead>
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th style="width: 140px;">დრო</th>
                            <th>VIN კოდი</th>
                            <th style="width: 140px;">სტატუსი</th>
                            <th style="width: 160px;">PDF / ქმედება</th>
                            <th style="width: 120px;">ქმედებები</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>


        <!-- Payment History -->
        <div class="card">
            <div class="collapsible-header" onclick="toggleCollapsible('paymentHistory')">
            <h3><i class="fas fa-history"></i> გადახდების ისტორია</h3>
                <div class="collapsible-toggle" id="paymentHistoryToggle">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapsible-content" id="paymentHistoryContent">
            <div class="table-container">
                <div class="table-wrap">
                    <table class="table" id="paymentHistoryTable">
                        <thead>
                            <tr>
                                <th>თარიღი</th>
                                <th>თანხა</th>
                                <th>კრედიტები</th>
                                <th>სტატუსი</th>
                                <th>ინვოისის ნომერი</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Credit Transaction History -->
        <div class="card">
            <div class="collapsible-header" onclick="toggleCollapsible('creditHistory')">
            <h3><i class="fas fa-coins"></i> კრედიტების ისტორია</h3>
                <div class="collapsible-toggle" id="creditHistoryToggle">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapsible-content" id="creditHistoryContent">
            <div class="table-container">
                <div class="table-wrap">
                    <table class="table" id="creditHistoryTable">
                        <thead>
                            <tr>
                                <th>თარიღი</th>
                                <th>მოქმედება</th>
                                <th>რაოდენობა</th>
                                <th>მიზეზი</th>
                                <th>ნაშთი</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal" style="display: none;">
        <div class="modal-content profile-modal" style="max-width: 700px; width: 90%; max-height: 90vh;">
            <div class="modal-body profile-modal-body" id="profileModalContent" style="overflow-y: visible; max-height: 90vh; padding: 0;">
                <!-- Profile content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-credit-card"></i> კრედიტების შეძენა</h3>
                <button class="modal-close" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-form">
                    <!-- Credit Packages -->
                    <div class="credit-packages">
                        <h4>აირჩიეთ კრედიტების პაკეტი:</h4>
                        <div class="package-options">
                            <div class="package-option" data-amount="7" data-credits="1">
                                <div class="package-header">
                                    <h5>Individual</h5>
                                    <div class="package-price">7₾</div>
                                </div>
                                <div class="package-credits">1 კრედიტი</div>
                                <div class="package-description">პირადი გამოყენებისთვის</div>
                            </div>
                            <div class="package-option popular" data-amount="30" data-credits="5">
                                <div class="package-badge">ყველაზე პოპულარული</div>
                                <div class="package-header">
                                    <h5>Popular</h5>
                                    <div class="package-price">30₾</div>
                                </div>
                                <div class="package-credits">5 კრედიტი</div>
                                <div class="package-description">ყველაზე მომგებიანი</div>
                            </div>
                            <div class="package-option" data-amount="50" data-credits="10">
                                <div class="package-header">
                                    <h5>Business</h5>
                                    <div class="package-price">50₾</div>
                                </div>
                                <div class="package-credits">10 კრედიტი</div>
                                <div class="package-description">ბიზნეს გამოყენებისთვის</div>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Bank Information -->
                    <div class="bank-info-section" id="bankInfoSection" style="display: none;">
                        <h4>ბანკის ინფორმაცია</h4>
                        <div class="bank-details">
                            <div class="bank-item price-item">
                                <label>გადასახდელი თანხა:</label>
                                <span id="bankAmount" class="price-amount">0₾</span>
                                <button class="copy-btn" onclick="copyToClipboard('bankAmount')" title="კოპირება">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="bank-item">
                                <label>ბანკი:</label>
                                <span id="bankName">TBC Bank</span>
                                <button class="copy-btn" onclick="copyToClipboard('bankName')" title="კოპირება">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="bank-item">
                                <label>IBAN:</label>
                                <span id="bankIban">GE29TB0000000000000000000</span>
                                <button class="copy-btn" onclick="copyToClipboard('bankIban')" title="კოპირება">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="bank-item">
                                <label>მიმღები:</label>
                                <span id="bankRecipient">VINaris Ltd</span>
                                <button class="copy-btn" onclick="copyToClipboard('bankRecipient')" title="კოპირება">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="bank-item">
                                <label>ინვოისის ნომერი:</label>
                                <span id="invoiceNumber" style="font-weight: bold; color: var(--accent);">INV-2024-000001</span>
                                <button class="copy-btn" onclick="copyToClipboard('invoiceNumber')" title="კოპირება">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden date/time fields - automatically set -->
                    <input type="date" id="paymentDate" style="display: none;">
                    <input type="time" id="paymentTime" style="display: none;">
                    
                    <!-- Payment Warning -->
                    <div class="payment-warning">
                        <div class="warning-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="warning-content">
                            <h5>⚠️ მნიშვნელოვანი</h5>
                            <p>გთხოვთ, შეინახოთ გადახდის დოკუმენტი (ბანკის ქვითარი ან SMS). კრედიტების მიღებისთვის დოკუმენტი აუცილებელია!</p>
                            <p style="margin-top: 8px; font-weight: 600; color: var(--accent);">
                                💡 გადახდისას ბანკში უნდა მიუთითოთ ზემოთ მოცემული ინვოისის ნომერი!
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePaymentModal()">გაუქმება</button>
                <button class="btn btn-primary" onclick="submitPaymentRequest()">
                    <i class="fas fa-paper-plane"></i> გადახდის მოთხოვნის გაგზავნა
                </button>
            </div>
        </div>
    </div>

    <script src="../js/xampp-api-utils.js"></script>
    <script>
        // Collapsible functionality
        function toggleCollapsible(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const toggle = document.getElementById(sectionId + 'Toggle');
            
            if (content.classList.contains('collapsed')) {
                // Expand
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
            } else {
                // Collapse
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
            }
        }

        // Global variables
        let currentUser = null;
        let authCheckInProgress = false;
        let redirectInProgress = false;
        
        // Wait for scripts to load before checking authentication
        async function checkAuthentication() {
            // Prevent multiple simultaneous auth checks
            if (authCheckInProgress) {
                console.log('Auth check already in progress, skipping...');
                return;
            }
            
            // Check if required classes are loaded
            if (typeof EnhancedAuth === 'undefined') {
                console.error('EnhancedAuth not loaded, retrying...');
                setTimeout(checkAuthentication, 100);
                return;
            }
            
            authCheckInProgress = true;
            console.log('Checking authentication...');
            
            // Check if we already have a valid local session
            if (EnhancedAuth.isLoggedIn()) {
                currentUser = EnhancedAuth.getCurrentUser();
                if (currentUser && currentUser.id) {
                    console.log('Valid local session found, user:', currentUser.name);
                    authCheckInProgress = false;
                    initializePanel();
                    return;
                }
            }
            
            // If no local session, try to restore from server (but don't fail if it doesn't work)
            console.log('No local session, attempting to restore from server...');
            try {
                const refreshedUser = await EnhancedAuth.refreshUserData();
                if (refreshedUser && refreshedUser.id) {
                    console.log('Session restored successfully:', refreshedUser.name);
                    currentUser = refreshedUser;
                    authCheckInProgress = false;
                    initializePanel();
                    return;
                } else {
                    console.log('Server session restoration returned no user data');
                }
            } catch (error) {
                console.log('Session restoration failed:', error.message);
                // Don't fail immediately, check if we have any local data
            }
            
            // Check one more time if we have local data (in case refreshUserData cleared it)
            if (EnhancedAuth.isLoggedIn()) {
                currentUser = EnhancedAuth.getCurrentUser();
                if (currentUser && currentUser.id) {
                    console.log('Found local session after server attempt, user:', currentUser.name);
                    authCheckInProgress = false;
                    initializePanel();
                    return;
                }
            }
            
            // If all attempts failed, redirect to login
            console.log('No valid session found, redirecting to login...');
            authCheckInProgress = false;
            showAuthErrorAndRedirect();
        }
        
        function initializePanel() {
            // Initialize the panel after authentication is confirmed
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeUserPanelAfterAuth);
            } else {
                initializeUserPanelAfterAuth();
            }
        }
        
        function showAuthErrorAndRedirect() {
            // Prevent multiple redirects
            if (redirectInProgress) {
                console.log('Redirect already in progress, skipping...');
                return;
            }
            
            redirectInProgress = true;
            
            // Show a brief message before redirecting
            if (typeof EnhancedUI !== 'undefined') {
                EnhancedUI.showToast('ავტორიზაცია ვერ მოხერხდა. გადამისამართება...', 'error');
            }
            
            // Show a login button as fallback
            showLoginFallback();
            
            setTimeout(() => {
                if (!redirectInProgress) return; // Prevent double redirect
                console.log('Redirecting to login page...');
            window.location.href = '../Login/login.html';
            }, 3000);
        }
        
        function showLoginFallback() {
            // Create a login overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const loginBox = document.createElement('div');
            loginBox.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                text-align: center;
                max-width: 400px;
                margin: 20px;
            `;
            
            loginBox.innerHTML = `
                <h2 style="color: #e60000; margin-bottom: 20px;">ავტორიზაცია საჭიროა</h2>
                <p style="margin-bottom: 20px;">გთხოვთ შეხვიდეთ სისტემაში</p>
                <button onclick="window.location.href='../Login/login.html'" 
                        style="background: #e60000; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 10px;">
                    შესვლა
                </button>
                <button onclick="this.closest('.overlay').remove()" 
                        style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 10px;">
                    გაუქმება
                </button>
            `;
            
            overlay.className = 'overlay';
            overlay.appendChild(loginBox);
            document.body.appendChild(overlay);
        }
        
        // Start authentication check
        checkAuthentication();
        let ui = {
            search: "",
            statusFilter: "all"
        };

        // Initialize user panel
        function initializeUserPanelAfterAuth() {
            console.log('Initializing user panel after authentication...');
            
            try {
                // Check if required classes are available
                if (typeof EnhancedAuth === 'undefined') {
                    console.error('EnhancedAuth not available');
                    return;
                }
                if (typeof EnhancedUI === 'undefined') {
                    console.error('EnhancedUI not available');
                    return;
                }
                if (typeof VinRequestManager === 'undefined') {
                    console.error('VinRequestManager not available');
                    return;
                }
                if (typeof PaymentManager === 'undefined') {
                    console.error('PaymentManager not available');
                    return;
                }
                
                // Ensure currentUser is available
                if (!currentUser) {
                    currentUser = EnhancedAuth.getCurrentUser();
                }
                
                if (!currentUser || !currentUser.id) {
                    console.error('No valid user data available');
                    window.location.href = '../Login/login.html';
                    return;
                }
                
                console.log('All required classes are available, user:', currentUser.name);
                
            initializeUserPanel();
            loadUserData();
            setupEventListeners();
            startPeriodicUpdates();
                
                console.log('User panel initialized successfully');
            } catch (error) {
                console.error('Error initializing user panel:', error);
                alert('Error initializing user panel: ' + error.message);
            }
        }
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded fired');
            
            // Only initialize if user is authenticated
            if (typeof EnhancedAuth !== 'undefined' && EnhancedAuth.isLoggedIn()) {
                initializeUserPanelAfterAuth();
            } else {
                console.log('User not authenticated, skipping initialization');
            }
        });
        
        // Add initializePage function for compatibility
        window.initializePage = function() {
            console.log('User panel page-specific initialization...');
            
            // Ensure currentUser is available
            if (!currentUser && typeof EnhancedAuth !== 'undefined') {
                currentUser = EnhancedAuth.getCurrentUser();
            }
            
            if (currentUser && currentUser.id) {
                loadUserData();
            } else {
                console.error('No valid user data for page initialization');
            }
        };

        function initializeUserPanel() {
            // Update user info in header
            document.getElementById('userNameHeader').textContent = currentUser.name;
            
            // Initialize collapsible sections (start collapsed by default)
            setTimeout(() => {
                // Set payment history to collapsed state
                const paymentContent = document.getElementById('paymentHistoryContent');
                const paymentToggle = document.getElementById('paymentHistoryToggle');
                if (paymentContent && paymentToggle) {
                    paymentContent.classList.add('collapsed');
                    paymentToggle.classList.add('collapsed');
                    paymentToggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
                }
                
                // Set credit history to collapsed state
                const creditContent = document.getElementById('creditHistoryContent');
                const creditToggle = document.getElementById('creditHistoryToggle');
                if (creditContent && creditToggle) {
                    creditContent.classList.add('collapsed');
                    creditToggle.classList.add('collapsed');
                    creditToggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
                }
            }, 100);
        }

        async function loadUserData() {
            try {
                EnhancedUI.showLoading('მონაცემების განახლება...');
                
                // Refresh user data from API
                const profileData = await UserManager.getProfile();
                
                if (!profileData || !profileData.user) {
                    throw new Error('Invalid profile data received');
                }
                
                currentUser = profileData.user;
                
                // Update cached user data
                TokenManager.setCurrentUser(currentUser);
                
                updateMetrics();
                await renderRequests();
                await renderCreditHistory();
                await renderPaymentHistory();
                
                EnhancedUI.hideLoading();
            } catch (error) {
                EnhancedUI.hideLoading();
                console.error('Error loading user data:', error);
                
                // Check if it's an authentication error
                if (error.message && (error.message.includes('401') || error.message.includes('Not authenticated'))) {
                    EnhancedUI.showToast('ავტორიზაცია ვერ მოხერხდა. გადამისამართება...', 'error');
                    setTimeout(() => {
                        window.location.href = '../Login/login.html';
                    }, 2000);
                } else {
                EnhancedUI.showToast('მონაცემების განახლება ვერ მოხერხდა', 'error');
                }
            }
        }

        function updateMetrics() {
            // Animate value updates
            animateValue(document.getElementById('userCredits'), currentUser.credits);
        }

        function animateValue(el, newVal, duration = 600) {
            const start = parseInt(el.textContent) || 0;
            const end = newVal;
            const startTime = performance.now();
            
            function step(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (end - start) * progress);
                el.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            }
            
            requestAnimationFrame(step);
        }

        async function renderRequests() {
            try {
                const requests = await VinRequestManager.getUserRequests();
                let filteredRequests = requests;

                // Apply filters
                if (ui.search) {
                    filteredRequests = filteredRequests.filter(r => 
                        r.vin.toLowerCase().includes(ui.search.toLowerCase()) ||
                        (r.id && r.id.toString().includes(ui.search))
                    );
                }

                if (ui.statusFilter !== "all") {
                    filteredRequests = filteredRequests.filter(r => r.status === ui.statusFilter);
                }

                const tbody = document.querySelector('#requestsTable tbody');
                
                // Update counts
                animateValue(document.getElementById('sentCount'), requests.length);
                animateValue(document.getElementById('pendingCount'), requests.filter(r => r.status === "pending").length);
                animateValue(document.getElementById('processedCount'), requests.filter(r => r.status === "completed" || r.status === "delivered").length);
                
                if (filteredRequests.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 60px; color: var(--muted);">
                                <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 16px; display: block;"></i>
                                VIN მოთხოვნები არ არის
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = filteredRequests.map(request => {
                    const statusPill = `<span class="pill ${request.status}"><span class="dot"></span> ${getStatusLabel(request.status)}</span>`;
                    let actionColumn = '';

                    if ((request.status === 'delivered' || request.status === 'processed') && request.pdf_filename) {
                        actionColumn = `
                            <button class="download-btn" onclick="downloadPDF('${request.id}')">
                                <i class="fas fa-download"></i> ჩამოტვირთვა
                            </button>
                        `;
                    } else if (request.status === 'completed' && request.pdf_filename) {
                        actionColumn = `
                            <button class="download-btn" onclick="downloadPDF('${request.id}')">
                                <i class="fas fa-download"></i> ჩამოტვირთვა
                            </button>
                        `;
                    } else if ((request.status === 'completed' || request.status === 'processed') && !request.pdf_filename) {
                        actionColumn = `
                            <span style="color: var(--info); font-size: 12px;">
                                <i class="fas fa-file-pdf"></i> PDF მომზადებაში
                            </span>
                        `;
                    } else if (request.status === 'pending') {
                        actionColumn = `
                            <span style="color: var(--warning); font-size: 12px;">
                                <i class="fas fa-clock"></i> დამუშავებაში...
                            </span>
                        `;
                    } else if (request.status === 'rejected') {
                        actionColumn = `
                            <span style="color: var(--accent); font-size: 12px;">
                                <i class="fas fa-times"></i> უარყოფილი
                            </span>
                        `;
                    }

                    return `
                        <tr>
                            <td><code style="font-size: 11px;">${request.id}</code></td>
                            <td><div style="font-size: 13px;">${EnhancedUI.formatDate(request.createdAt)}</div></td>
                            <td><code style="font-family: monospace; font-weight: 600; letter-spacing: 1px;">${request.vin}</code></td>
                            <td>${statusPill}</td>
                            <td>${actionColumn}</td>
                            <td>
                                <button class="btn" style="padding: 6px 8px; font-size: 12px;" onclick="viewRequestDetails('${request.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error rendering requests:', error);
                EnhancedUI.showToast('მოთხოვნების ჩატვირთვა ვერ მოხერხდა', 'error');
            }
        }

        async function renderCreditHistory() {
            try {
                const transactions = await CreditManager.getUserCreditTransactions(10);
                const tbody = document.querySelector('#creditHistoryTable tbody');
                
                if (transactions.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--muted);">
                                კრედიტების ისტორია ცარიელია
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = transactions.map(transaction => `
                    <tr>
                        <td>${EnhancedUI.formatDate(transaction.createdAt)}</td>
                        <td>
                            <i class="fas fa-${transaction.amount > 0 ? 'plus' : 'minus'}" style="color: ${transaction.amount > 0 ? 'var(--success)' : 'var(--accent)'};"></i>
                            ${transaction.amount > 0 ? 'დამატება' : 'ჩამოწერა'}
                        </td>
                        <td style="color: ${transaction.amount > 0 ? 'var(--success)' : 'var(--accent)'}; font-weight: bold;">
                            ${transaction.amount > 0 ? '+' : ''}${transaction.amount}
                        </td>
                        <td>${transaction.reason}</td>
                        <td>${transaction.balance_after}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error rendering credit history:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--danger);">
                            შეცდომა კრედიტების ისტორიის ჩატვირთვისას
                        </td>
                    </tr>
                `;
            }
        }

        async function renderPaymentHistory() {
            try {
                const payments = await PaymentManager.getUserPaymentRequests(20);
                const tbody = document.querySelector('#paymentHistoryTable tbody');
                
                if (payments.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--muted);">
                                გადახდების ისტორია ცარიელია
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = payments.map(payment => {
                    const status = PaymentManager.formatPaymentStatus(payment.status);
                    return `
                        <tr>
                            <td>${EnhancedUI.formatDate(payment.createdAt)}</td>
                            <td>${payment.amount} ₾</td>
                            <td>${payment.credits}</td>
                            <td>
                                <span class="status-badge ${status.class}">${status.text}</span>
                            </td>
                            <td>${payment.invoiceNumber || 'N/A'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error rendering payment history:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--danger);">
                            შეცდომა გადახდების ისტორიის ჩატვირთვისას
                        </td>
                    </tr>
                `;
            }
        }

        async function submitPaymentRequest() {
            // Check if a package is selected
            if (!selectedPackage) {
                EnhancedUI.showToast('გთხოვთ აირჩიოთ კრედიტების პაკეტი', 'error');
                return;
            }

            const amount = parseFloat(selectedPackage.amount);
            const credits = parseInt(selectedPackage.credits);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentTime = document.getElementById('paymentTime').value;
            
            // Get the generated invoice number
            const invoiceElement = document.getElementById('invoiceNumber');
            const invoiceNumber = invoiceElement ? invoiceElement.getAttribute('data-invoice') : '';

            try {
                const paymentData = {
                    amount: amount,
                    credits: credits,
                    payment_date: paymentDate,
                    payment_time: paymentTime,
                    invoice_number: invoiceNumber,
                    user_notes: '',
                    currency: 'GEL',
                    payment_method: 'bank_transfer'
                };

                console.log('Sending payment data:', paymentData);
                console.log('Invoice number:', invoiceNumber);

                const result = await PaymentManager.createPaymentRequest(paymentData);
                if (result) {
                    EnhancedUI.showToast('გადახდის მოთხოვნა წარმატებით გაიგზავნა!', 'success');
                    
                    // Close modal and clear form
                    closePaymentModal();
                    
                    // Refresh payment history
                    await renderPaymentHistory();
                } else {
                    EnhancedUI.showToast('გადახდის მოთხოვნის გაგზავნა ვერ მოხერხდა', 'error');
                }
            } catch (error) {
                console.error('Error submitting payment request:', error);
                console.error('Error details:', {
                    message: error.message,
                    status: error.status,
                    response: error.response
                });
                
                let errorMessage = 'შეცდომა: ' + error.message;
                if (error.response && error.response.data && error.response.data.message) {
                    errorMessage = 'შეცდომა: ' + error.response.data.message;
                }
                
                EnhancedUI.showToast(errorMessage, 'error');
            }
        }

        function openPaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.style.display = 'flex';
            
            // Automatically set current date and time
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const timeString = now.toTimeString().slice(0, 5);
            
            document.getElementById('paymentDate').value = today;
            document.getElementById('paymentTime').value = timeString;
            
            // Generate unique invoice number
            generateInvoiceNumber();
            
            // Initialize package selection
            initializePackageSelection();
            
            // Add click outside to close
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closePaymentModal();
                }
            };
            
            // Add escape key to close
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && modal.style.display === 'flex') {
                    closePaymentModal();
                }
            });
        }

        function generateInvoiceNumber() {
            // Generate a shorter, easier to remember invoice number
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2); // Last 2 digits of year
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            
            // Create a random 4-digit number for uniqueness (easier to remember than 3 digits)
            const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            // Format: INV-YYMMDD-XXXX (much shorter and easier to remember)
            const invoiceNumber = `INV-${year}${month}${day}-${randomNum}`;
            
            // Update the invoice number in the UI
            const invoiceElement = document.getElementById('invoiceNumber');
            if (invoiceElement) {
                invoiceElement.textContent = invoiceNumber;
                // Store it for later use in payment submission
                invoiceElement.setAttribute('data-invoice', invoiceNumber);
            }
            
            return invoiceNumber;
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.style.display = 'none';
            
            // Clear form (date/time are automatically set, don't clear them)
            
            // Clear package selection
            document.querySelectorAll('.package-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Hide bank information section
            const bankInfoSection = document.getElementById('bankInfoSection');
            if (bankInfoSection) {
                bankInfoSection.style.display = 'none';
            }
            
            // Reset bank amount
            const bankAmount = document.getElementById('bankAmount');
            if (bankAmount) {
                bankAmount.textContent = '0₾';
            }
            
            // Clear selected package
            selectedPackage = null;
        }

        // Package Selection Functions
        function initializePackageSelection() {
            const packageOptions = document.querySelectorAll('.package-option');
            
            packageOptions.forEach(option => {
                option.addEventListener('click', function() {
                    selectPackage(this);
                });
            });
        }

        // Store selected package data
        let selectedPackage = null;

        // Calculate credits function
        function calculateCredits() {
            const paymentAmountInput = document.getElementById('paymentAmount');
            if (!paymentAmountInput) return;
            
            const amount = parseFloat(paymentAmountInput.value) || 0;
            const credits = Math.floor(amount * 10); // 1 GEL = 10 credits
            
            // Update credits display
            const creditsDisplay = document.getElementById('creditsDisplay');
            if (creditsDisplay) {
                creditsDisplay.textContent = credits;
            }
            
            // Update bank amount
            const bankAmount = document.getElementById('bankAmount');
            if (bankAmount) {
                bankAmount.textContent = `${amount}₾`;
            }
        }

        function selectPackage(packageElement) {
            // Remove selected class from all packages
            document.querySelectorAll('.package-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked package
            packageElement.classList.add('selected');
            
            // Get package data and store it
            const amount = packageElement.getAttribute('data-amount');
            const credits = packageElement.getAttribute('data-credits');
            const name = packageElement.querySelector('h5').textContent;
            
            selectedPackage = {
                amount: amount,
                credits: credits,
                name: name
            };
            
            // Show bank information section
            const bankInfoSection = document.getElementById('bankInfoSection');
            if (bankInfoSection) {
                bankInfoSection.style.display = 'block';
                bankInfoSection.style.animation = 'slideInDown 0.5s ease-out';
            }
            
            // Update bank amount
            const bankAmount = document.getElementById('bankAmount');
            if (bankAmount) {
                bankAmount.textContent = `${amount}₾`;
            }
            
            // Show success message
            EnhancedUI.showToast(`აირჩიეთ ${name} პაკეტი - ${amount}₾`, 'success');
        }


        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                EnhancedUI.showToast('კოპირებულია!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                EnhancedUI.showToast('კოპირება ვერ მოხერხდა', 'error');
            });
        }


        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            try {
            // VIN input validation
            const vinInput = document.getElementById('vinInput');
            const vinCharCount = document.getElementById('vinCharCount');
                
                if (!vinInput) {
                    console.error('vinInput element not found');
                    return;
                }
                if (!vinCharCount) {
                    console.error('vinCharCount element not found');
                    return;
                }
            
            // Payment amount calculation
            const paymentAmountInput = document.getElementById('paymentAmount');
            if (paymentAmountInput) {
                paymentAmountInput.addEventListener('input', calculateCredits);
            }
            const sendVinBtn = document.getElementById('sendVinBtn');

            vinInput.addEventListener('input', (e) => {
                const value = e.target.value.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
                e.target.value = value;
                vinCharCount.textContent = value.length;
                
                const hasCredits = currentUser.credits >= 1;
                const validLength = value.length === 17;
                sendVinBtn.disabled = !hasCredits || !validLength;
                
                if (!hasCredits) {
                    sendVinBtn.innerHTML = '<i class="fas fa-ban"></i> არასაკმარისი კრედიტი';
                } else if (!validLength) {
                    sendVinBtn.innerHTML = '<i class="fas fa-search"></i> შემოწმება (1 კრედიტი)';
                } else {
                    sendVinBtn.innerHTML = '<i class="fas fa-search"></i> შემოწმება (1 კრედიტი)';
                }
            });

            // VIN submission
            sendVinBtn.addEventListener('click', submitVinRequest);

            // Enter key support
            vinInput.addEventListener('keydown', (e) => {
                if (e.key === "Enter" && !sendVinBtn.disabled) {
                    submitVinRequest();
                }
            });

            // Search and filter
            document.getElementById('searchInput').addEventListener('input', (e) => {
                ui.search = e.target.value;
                renderRequests();
            });

            document.getElementById('statusFilter').addEventListener('change', (e) => {
                ui.statusFilter = e.target.value;
                renderRequests();
            });

            // Other buttons
            const refreshBtn = document.getElementById('refreshBtn');
            const profileBtn = document.getElementById('profileBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadUserData);
                console.log('Refresh button event listener added');
            } else {
                console.error('refreshBtn element not found');
            }
            
            if (profileBtn) {
                profileBtn.addEventListener('click', showUserProfile);
                console.log('Profile button event listener added');
            } else {
                console.error('profileBtn element not found');
            }
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
                console.log('Logout button event listener added');
            } else {
                console.error('logoutBtn element not found');
            }
            
            console.log('Event listeners setup completed');
            } catch (error) {
                console.error('Error setting up event listeners:', error);
                alert('Error setting up event listeners: ' + error.message);
            }
        }

        async function submitVinRequest() {
            const vin = document.getElementById('vinInput').value.trim();
            const sendBtn = document.getElementById('sendVinBtn');

            if (!vin || vin.length !== 17) {
                EnhancedUI.showToast('გთხოვთ შეიყვანოთ სწორი 17-ნიშნა VIN კოდი', 'error');
                return;
            }

            try {
                // Show loading
                const originalText = sendBtn.innerHTML;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> იგზავნება...';
                sendBtn.disabled = true;

                // Submit VIN request via API
                const result = await VinRequestManager.createRequest(vin);
                
                // Clear input and update UI
                document.getElementById('vinInput').value = '';
                document.getElementById('vinCharCount').textContent = '0';
                
                // Refresh data
                await loadUserData();
                
                // Reset button
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = true;
                
            } catch (error) {
                console.error('VIN submission error:', error);
                
                // Better error handling
                let errorMessage = 'VIN შემოწმება ვერ მოხერხდა: ';
                if (error.message && error.message.includes('401')) {
                    errorMessage += 'ავტორიზაცია ვერ მოხერხდა. გთხოვთ შეხვიდეთ თავიდან.';
                    // Redirect to login after showing error
                    setTimeout(() => {
                        window.location.href = '../Login/login.html';
                    }, 2000);
                } else if (error.message && error.message.includes('400')) {
                    errorMessage += 'არასაკმარისი კრედიტი ან არასწორი მონაცემები.';
                } else {
                    errorMessage += (error.message || 'უცნობი შეცდომა');
                }
                
                EnhancedUI.showToast(errorMessage, 'error');
                sendBtn.innerHTML = '<i class="fas fa-search"></i> შემოწმება (1 კრედიტი)';
                sendBtn.disabled = false;
            }
        }

        async function generatePDF(id) {
            try {
                EnhancedUI.showLoading('PDF შექმნა...');
                await VinRequestManager.generatePDF(id);
                EnhancedUI.hideLoading();
                await renderRequests(); // Refresh to show download button
            } catch (error) {
                EnhancedUI.hideLoading();
                console.error('PDF generation error:', error);
            }
        }

        async function downloadPDF(id) {
            try {
                await VinRequestManager.downloadPDF(id);
                EnhancedUI.showToast('PDF downloaded successfully!', 'success');
            } catch (error) {
                console.error('PDF download error:', error);
                EnhancedUI.showToast('Failed to download PDF: ' + error.message, 'error');
            }
        }

        function viewRequestDetails(id) {
            // Show modal with request details
            EnhancedUI.showToast(`მოთხოვნის დეტალები: ${id}`, 'info');
        }

        async function showUserProfile() {
            try {
                console.log('showUserProfile called');
                EnhancedUI.showLoading('პროფილის ჩატვირთვა...');
                
                // Get current user data
                const profileData = await UserManager.getProfile();
                if (!profileData || !profileData.user) {
                    throw new Error('Invalid profile data received');
                }
                const user = profileData.user;
                
                // Get user's VIN request history
                let requests = [];
                try {
                    requests = await VinRequestManager.getAllRequests();
                } catch (requestError) {
                    console.warn('Could not load VIN requests:', requestError);
                    // Continue without requests data
                }
                
                const totalRequests = requests.length;
                const pendingRequests = requests.filter(r => r.status === 'pending').length;
                const completedRequests = requests.filter(r => r.status === 'processed' || r.status === 'delivered').length;
                
                // Calculate account age
                const registrationDate = new Date(user.created_at || user.registration_date || new Date());
                const now = new Date();
                const accountAge = Math.floor((now - registrationDate) / (1000 * 60 * 60 * 24));
                
                // Create profile modal content
                const profileModalContent = createProfileModal(user, totalRequests, pendingRequests, completedRequests, accountAge, requests);
                
                // Show the modal with the profile content
                console.log('About to show profile modal');
                showProfileModal(profileModalContent);
                console.log('Profile modal should be displayed now');
                
                // Initialize collapsible sections in profile modal
                setTimeout(() => {
                    const profileActivityContent = document.getElementById('profileActivityContent');
                    const profileActivityToggle = document.getElementById('profileActivityToggle');
                    if (profileActivityContent && profileActivityToggle) {
                        profileActivityContent.classList.add('collapsed');
                        profileActivityToggle.classList.add('collapsed');
                        profileActivityToggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    }
                }, 100);

            } catch (error) {
                console.error('Error loading profile:', error);
                EnhancedUI.showToast('პროფილის ჩატვირთვა ვერ მოხერხდა: ' + (error.message || 'Unknown error'), 'error');
            } finally {
                EnhancedUI.hideLoading();
            }
        }

        function createProfileModal(user, totalRequests, pendingRequests, completedRequests, accountAge, requests) {
            return `
                <div class="profile-modal-container">
                    <!-- Profile Header -->
                    <div class="profile-header">
                        <div class="profile-header-left">
                        <div class="profile-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="profile-title">
                            <h2>${user.name}</h2>
                            <p class="profile-email">${user.email}</p>
                            <span class="profile-status active">აქტიური მომხმარებელი</span>
                        </div>
                        </div>
                        <button class="profile-close-btn" onclick="closeProfileModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Profile Actions -->
                    <div class="profile-actions">
                        <button class="btn btn-primary" onclick="editProfile()">
                            <i class="fas fa-edit"></i> პროფილის რედაქტირება
                        </button>
                        <button class="btn btn-secondary" onclick="changePassword()">
                            <i class="fas fa-key"></i> პაროლის შეცვლა
                        </button>
                        <button class="btn btn-info" onclick="downloadData()">
                            <i class="fas fa-download"></i> მონაცემების გადმოწერა
                        </button>
                    </div>


                    <!-- Profile Information -->
                    <div class="profile-info-section">
                        <h3><i class="fas fa-info-circle"></i> ინფორმაცია</h3>
                        
                        <!-- Personal Information Group -->
                        <div class="info-group">
                            <h4 class="info-group-title">
                                <i class="fas fa-user"></i> პირადი ინფორმაცია
                            </h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>მომხმარებლის ID</label>
                                    <span class="info-value">${user.id || user.uniqueId || 'N/A'}</span>
                                </div>
                                <div class="info-item">
                                    <label>ელ. ფოსტა</label>
                                    <span class="info-value">${user.email}</span>
                                </div>
                                <div class="info-item">
                                    <label>სტატუსი</label>
                                    <span class="status-badge active">აქტიური</span>
                                </div>
                            </div>
                        </div>

                        <!-- Account Information Group -->
                        <div class="info-group">
                            <h4 class="info-group-title">
                                <i class="fas fa-clock"></i> ანგარიშის ინფორმაცია
                            </h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>რეგისტრაციის თარიღი</label>
                                    <span class="info-value">${formatDate(user.created_at || user.registration_date)}</span>
                                </div>
                                <div class="info-item">
                                    <label>ანგარიშის ასაკი</label>
                                    <span class="info-value">${accountAge} დღე</span>
                                </div>
                                <div class="info-item">
                                    <label>ბოლო აქტივობა</label>
                                    <span class="info-value">${formatDate(user.lastActivity || user.last_login || new Date())}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="profile-activity-section">
                        <div class="collapsible-header" onclick="toggleCollapsible('profileActivity')">
                        <h3><i class="fas fa-history"></i> ბოლო აქტივობა</h3>
                            <div class="collapsible-toggle" id="profileActivityToggle">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="collapsible-content" id="profileActivityContent">
                        <div class="activity-list">
                            ${requests.slice(0, 3).map(request => `
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-car"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">VIN შემოწმება: ${request.vin}</div>
                                        <div class="activity-meta">
                                            <span class="activity-status status-${request.status}">${getStatusText(request.status)}</span>
                                            <span class="activity-date">${formatDate(request.createdAt)}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${requests.length === 0 ? `
                                <div class="no-activity">
                                    <i class="fas fa-inbox"></i>
                                    <p>ჯერ არ არის აქტივობა</p>
                                </div>
                            ` : ''}
                            </div>
                        </div>
                    </div>

                </div>

                <style>
                    .profile-modal-container {
                        max-width: 100%;
                        margin: 0;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        background: transparent;
                        border-radius: 0;
                        overflow: visible;
                        box-shadow: none;
                    }

                    .profile-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        gap: 12px;
                        padding: 16px 20px;
                        background: linear-gradient(135deg, var(--accent), var(--accent-light));
                        color: white;
                        border-radius: 8px 8px 0 0;
                        margin-bottom: 12px;
                        box-shadow: 0 2px 10px rgba(230, 0, 0, 0.2);
                        position: relative;
                        overflow: hidden;
                    }

                    .profile-header-left {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        flex: 1;
                    }

                    .profile-close-btn {
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        color: white;
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        font-size: 16px;
                        transition: all 0.2s ease;
                        backdrop-filter: blur(10px);
                    }

                    .profile-close-btn:hover {
                        background: rgba(255, 255, 255, 0.3);
                        transform: scale(1.1);
                    }

                    .profile-header::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
                        pointer-events: none;
                    }

                    .profile-avatar {
                        width: 60px;
                        height: 60px;
                        background: rgba(255,255,255,0.2);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 30px;
                        backdrop-filter: blur(10px);
                    }

                    .profile-title h2 {
                        margin: 0 0 6px 0;
                        font-size: 22px;
                        font-weight: 700;
                    }

                    .profile-email {
                        margin: 0 0 6px 0;
                        opacity: 0.9;
                        font-size: 14px;
                    }

                    .profile-status {
                        display: inline-block;
                        padding: 3px 10px;
                        background: rgba(255,255,255,0.2);
                        border-radius: 16px;
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }


                    .profile-info-section, .profile-activity-section {
                        background: var(--panel2);
                        border-radius: 8px;
                        padding: 12px;
                        margin: 6px 0;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        border: 1px solid var(--border);
                        transition: all 0.3s ease;
                    }

                    .profile-info-section:hover, .profile-activity-section:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                    }

                    .profile-info-section h3, .profile-activity-section h3 {
                        margin: 0 0 8px 0;
                        color: var(--txt);
                        font-size: 14px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }

                    .profile-activity-section .collapsible-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        cursor: pointer;
                        user-select: none;
                        transition: all 0.3s ease;
                        padding: 10px 0;
                        margin: -10px 0 20px 0;
                    }

                    .profile-activity-section .collapsible-header:hover {
                        color: var(--accent);
                    }

                    .profile-activity-section .collapsible-header h3 {
                        margin: 0;
                    }

                    .profile-activity-section .collapsible-toggle {
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        background: var(--panel);
                        border: 1px solid var(--border);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s ease;
                        font-size: 12px;
                        color: var(--txt);
                    }

                    .profile-activity-section .collapsible-toggle:hover {
                        background: var(--accent);
                        color: white;
                        transform: scale(1.1);
                    }

                    .profile-activity-section .collapsible-toggle.collapsed {
                        transform: rotate(-90deg);
                    }

                    .profile-activity-section .collapsible-content {
                        max-height: 1000px;
                        overflow: hidden;
                        transition: max-height 0.4s ease, opacity 0.3s ease;
                        opacity: 1;
                    }

                    .profile-activity-section .collapsible-content.collapsed {
                        max-height: 0;
                        opacity: 0;
                        margin-bottom: 0;
                    }

                    .info-group {
                        margin-bottom: 16px;
                        padding: 12px;
                        background: var(--panel);
                        border-radius: 6px;
                        border: 1px solid var(--border);
                    }

                    .info-group:last-child {
                        margin-bottom: 0;
                    }

                    .info-group-title {
                        margin: 0 0 10px 0;
                        color: var(--accent);
                        font-size: 13px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        border-bottom: 1px solid var(--border);
                        padding-bottom: 6px;
                    }

                    .info-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                        gap: 6px;
                    }

                    .info-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 4px 0;
                        border-bottom: 1px solid var(--border);
                    }

                    .info-item:last-child {
                        border-bottom: none;
                    }

                    .info-item label {
                        color: var(--muted);
                        font-weight: 500;
                        font-size: 14px;
                    }

                    .info-value {
                        color: var(--text);
                        font-weight: 600;
                        font-size: 14px;
                    }

                    .status-badge {
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                    }

                    .status-badge.active {
                        background: var(--success);
                        color: white;
                    }

                    .activity-list {
                        max-height: 250px;
                        overflow-y: auto;
                        padding-right: 5px;
                    }

                    .activity-list::-webkit-scrollbar {
                        width: 4px;
                    }

                    .activity-list::-webkit-scrollbar-track {
                        background: var(--bg);
                    }

                    .activity-list::-webkit-scrollbar-thumb {
                        background: var(--border);
                        border-radius: 2px;
                    }

                    .activity-list::-webkit-scrollbar-thumb:hover {
                        background: var(--border-light);
                    }

                    .activity-item {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 10px 0;
                        border-bottom: 1px solid var(--border);
                        transition: all 0.2s ease;
                        border-radius: 8px;
                        margin-bottom: 5px;
                    }

                    .activity-item:hover {
                        background: rgba(255, 255, 255, 0.02);
                        padding-left: 10px;
                        padding-right: 10px;
                        margin-left: -10px;
                        margin-right: -10px;
                    }

                    .activity-item:last-child {
                        border-bottom: none;
                    }

                    .activity-icon {
                        width: 32px;
                        height: 32px;
                        background: linear-gradient(135deg, var(--info), #60a5fa);
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 14px;
                        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                        transition: all 0.3s ease;
                    }

                    .activity-item:hover .activity-icon {
                        transform: scale(1.1);
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                    }

                    .activity-content {
                        flex: 1;
                    }

                    .activity-title {
                        font-weight: 600;
                        color: var(--text);
                        margin-bottom: 4px;
                    }

                    .activity-meta {
                        display: flex;
                        gap: 15px;
                        align-items: center;
                    }

                    .activity-status {
                        padding: 2px 6px;
                        border-radius: 8px;
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                    }

                    .status-pending { background: var(--warning); color: white; }
                    .status-processed { background: var(--success); color: white; }
                    .status-delivered { background: var(--info); color: white; }
                    .status-rejected { background: var(--danger); color: white; }

                    .activity-date {
                        color: var(--muted);
                        font-size: 12px;
                    }

                    .no-activity {
                        text-align: center;
                        padding: 40px;
                        color: var(--muted);
                    }

                    .no-activity i {
                        font-size: 48px;
                        margin-bottom: 15px;
                        display: block;
                    }

                    .profile-actions {
                        display: flex;
                        gap: 6px;
                        flex-wrap: wrap;
                        margin: 8px 0;
                        padding: 0 20px;
                        align-items: center;
                        justify-content: flex-start;
                    }

                    .profile-actions .btn {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 4px;
                        padding: 6px 10px;
                        border-radius: 6px;
                        font-weight: 600;
                        text-decoration: none;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                        font-size: 12px;
                        min-height: 32px;
                        flex: 1;
                        max-width: 160px;
                    }

                    .profile-actions .btn::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                        transition: left 0.6s ease;
                    }

                    .profile-actions .btn:hover::before {
                        left: 100%;
                    }

                    .profile-actions .btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                    }

                    @media (max-width: 768px) {
                        .profile-header {
                            flex-direction: column;
                            text-align: center;
                        }
                        
                        
                        .info-grid {
                            grid-template-columns: 1fr;
                        }

                        .info-group {
                            margin-bottom: 12px;
                            padding: 10px;
                        }

                        .info-group-title {
                            font-size: 12px;
                        }
                        
                        .profile-actions {
                            flex-direction: column;
                        }
                        
                        .profile-actions .btn {
                            width: 100%;
                            justify-content: center;
                        }
                    }
                </style>
            `;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'მუშავდება',
                'processed': 'დამუშავებულია',
                'delivered': 'დამუშავებულია',
                'rejected': 'უარყოფილი'
            };
            return statusMap[status] || status;
        }

        function editProfile() {
            const modal = document.getElementById('profileModal');
            const modalContent = document.getElementById('profileModalContent');
            
            if (!modal || !modalContent) return;
            
            const editForm = `
                <div class="profile-edit-container">
                    <div class="edit-header">
                        <div class="edit-header-left">
                        <h3><i class="fas fa-edit"></i> პროფილის რედაქტირება</h3>
                        </div>
                        <button class="profile-close-btn" onclick="closeProfileModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="profileEditForm" class="profile-edit-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editName">სახელი</label>
                                <input type="text" id="editName" value="${currentUser.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editEmail">ელ-ფოსტა</label>
                                <input type="email" id="editEmail" value="${currentUser.email || ''}" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editPhone">ტელეფონი</label>
                                <input type="tel" id="editPhone" value="${currentUser.phone || ''}" placeholder="+995 XXX XXX XXX">
                            </div>
                            <div class="form-group">
                                <label for="editCompany">კომპანია</label>
                                <input type="text" id="editCompany" value="${currentUser.company || ''}" placeholder="კომპანიის სახელი">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editAddress">მისამართი</label>
                            <textarea id="editAddress" rows="3" placeholder="სრული მისამართი">${currentUser.address || ''}</textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" onclick="saveProfileChanges(); console.log('Profile save button clicked');">
                                <i class="fas fa-save"></i> შენახვა
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            modalContent.innerHTML = editForm;
            
            // Add form submit handler
            setTimeout(() => {
                const form = document.getElementById('profileEditForm');
                if (form) {
                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        console.log('Profile form submitted');
                        await saveProfileChanges();
                    });
                    console.log('Profile form event listener added');
                } else {
                    console.error('Profile form not found');
                }
            }, 100);
        }

        async function saveProfileChanges() {
            try {
                console.log('saveProfileChanges called');
                
                const nameInput = document.getElementById('editName');
                const emailInput = document.getElementById('editEmail');
                const phoneInput = document.getElementById('editPhone');
                const companyInput = document.getElementById('editCompany');
                const addressInput = document.getElementById('editAddress');
                
                console.log('Input elements:', { nameInput, emailInput, phoneInput, companyInput, addressInput });
                
                const formData = {
                    name: nameInput ? nameInput.value.trim() : '',
                    email: emailInput ? emailInput.value.trim() : '',
                    phone: phoneInput ? phoneInput.value.trim() : '',
                    company: companyInput ? companyInput.value.trim() : '',
                    address: addressInput ? addressInput.value.trim() : ''
                };
                
                console.log('Form data:', formData);
                
                // Validate required fields
                if (!formData.name || !formData.email) {
                    alert('სახელი და ელ-ფოსტა აუცილებელია');
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(formData.email)) {
                    alert('გთხოვთ შეიყვანოთ სწორი ელ-ფოსტის მისამართი');
                    return;
                }
                
                console.log('Validation passed, starting save process...');
                
                // Show loading (fallback if EnhancedUI not available)
                if (typeof EnhancedUI !== 'undefined' && EnhancedUI.showLoading) {
                    EnhancedUI.showLoading('პროფილის განახლება...');
                } else {
                    console.log('Loading: პროფილის განახლება...');
                }
                
                // Simulate API call (replace with actual API call)
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Update current user data
                currentUser = { ...currentUser, ...formData };
                
                // Update cached user data
                if (typeof TokenManager !== 'undefined') {
                    TokenManager.setCurrentUser(currentUser);
                }
                
                // Show success message
                if (typeof EnhancedUI !== 'undefined' && EnhancedUI.showToast) {
                    EnhancedUI.showToast('პროფილი წარმატებით განახლდა', 'success');
                } else {
                    alert('პროფილი წარმატებით განახლდა');
                }
                
                console.log('Profile saved successfully');
                
                // Refresh profile display
                setTimeout(() => {
                    showUserProfile();
                }, 500);
                
            } catch (error) {
                console.error('Error saving profile:', error);
                if (typeof EnhancedUI !== 'undefined' && EnhancedUI.showToast) {
                    EnhancedUI.showToast('პროფილის განახლება ვერ მოხერხდა: ' + error.message, 'error');
                } else {
                    alert('პროფილის განახლება ვერ მოხერხდა: ' + error.message);
                }
            } finally {
                if (typeof EnhancedUI !== 'undefined' && EnhancedUI.hideLoading) {
                    EnhancedUI.hideLoading();
                }
                console.log('Profile save process completed');
            }
        }

        function cancelEdit() {
            console.log('Cancel edit called');
            showUserProfile();
        }

        // Test function to verify profile functions are accessible
        function testProfileFunctions() {
            console.log('Testing profile functions...');
            console.log('editProfile function:', typeof editProfile);
            console.log('changePassword function:', typeof changePassword);
            console.log('saveProfileChanges function:', typeof saveProfileChanges);
            console.log('savePasswordChange function:', typeof savePasswordChange);
            console.log('currentUser:', currentUser);
        }

        function changePassword() {
            const modal = document.getElementById('profileModal');
            const modalContent = document.getElementById('profileModalContent');
            
            if (!modal || !modalContent) return;
            
            const passwordForm = `
                <div class="password-change-container">
                    <div class="password-header">
                        <div class="password-header-left">
                        <h3><i class="fas fa-key"></i> პაროლის შეცვლა</h3>
                        <p>შეიყვანეთ ამჟამინდელი პაროლი და ახალი პაროლი</p>
                        </div>
                        <button class="profile-close-btn" onclick="closeProfileModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="passwordChangeForm" class="password-change-form">
                        <div class="form-group">
                            <label for="currentPassword">ამჟამინდელი პაროლი</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newPassword">ახალი პაროლი</label>
                            <input type="password" id="newPassword" required minlength="8">
                            <small class="password-hint">მინიმუმ 8 სიმბოლო</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword">ახალი პაროლის დადასტურება</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" onclick="savePasswordChange(); console.log('Password save button clicked');">
                                <i class="fas fa-save"></i> პაროლის შეცვლა
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            modalContent.innerHTML = passwordForm;
            
            // Add form submit handler
            setTimeout(() => {
                const form = document.getElementById('passwordChangeForm');
                if (form) {
                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        console.log('Password form submitted');
                        await savePasswordChange();
                    });
                    console.log('Password form event listener added');
                } else {
                    console.error('Password form not found');
                }
            }, 100);
        }

        async function savePasswordChange() {
            try {
                console.log('savePasswordChange called');
                
                const currentPasswordInput = document.getElementById('currentPassword');
                const newPasswordInput = document.getElementById('newPassword');
                const confirmPasswordInput = document.getElementById('confirmPassword');
                
                console.log('Password inputs:', { currentPasswordInput, newPasswordInput, confirmPasswordInput });
                
                const currentPassword = currentPasswordInput ? currentPasswordInput.value : '';
                const newPassword = newPasswordInput ? newPasswordInput.value : '';
                const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';
                
                console.log('Password values:', { currentPassword: currentPassword ? '***' : 'empty', newPassword: newPassword ? '***' : 'empty', confirmPassword: confirmPassword ? '***' : 'empty' });
                
                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    alert('ყველა ველი აუცილებელია');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('ახალი პაროლები არ ემთხვევა');
                    return;
                }
                
                if (newPassword.length < 8) {
                    alert('ახალი პაროლი უნდა იყოს მინიმუმ 8 სიმბოლო');
                    return;
                }
                
                console.log('Password validation passed, starting change process...');
                
                // Show loading (fallback if EnhancedUI not available)
                if (typeof EnhancedUI !== 'undefined' && EnhancedUI.showLoading) {
                    EnhancedUI.showLoading('პაროლის შეცვლა...');
                } else {
                    console.log('Loading: პაროლის შეცვლა...');
                }
                
                // Simulate API call (replace with actual API call)
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Show success message
                if (typeof EnhancedUI !== 'undefined' && EnhancedUI.showToast) {
                    EnhancedUI.showToast('პაროლი წარმატებით შეიცვალა', 'success');
                } else {
                    alert('პაროლი წარმატებით შეიცვალა');
                }
                
                console.log('Password changed successfully');
                
                // Clear form and return to profile
                setTimeout(() => {
                    showUserProfile();
                }, 1000);
                
            } catch (error) {
                console.error('Error changing password:', error);
                if (typeof EnhancedUI !== 'undefined' && EnhancedUI.showToast) {
                    EnhancedUI.showToast('პაროლის შეცვლა ვერ მოხერხდა: ' + error.message, 'error');
                } else {
                    alert('პაროლის შეცვლა ვერ მოხერხდა: ' + error.message);
                }
            } finally {
                if (typeof EnhancedUI !== 'undefined' && EnhancedUI.hideLoading) {
                    EnhancedUI.hideLoading();
                }
                console.log('Password change process completed');
            }
        }

        function cancelPasswordChange() {
            console.log('Cancel password change called');
            showUserProfile();
        }

        async function downloadData() {
            try {
                EnhancedUI.showLoading('მონაცემების მომზადება...');
                
                // Get user data
                const userData = {
                    profile: currentUser,
                    requests: [], // await VinRequestManager.getUserRequests(),
                    payments: [], // await PaymentManager.getUserPaymentRequests(),
                    credits: [] // await CreditManager.getUserCreditTransactions()
                };
                
                // Create downloadable content
                const dataContent = JSON.stringify(userData, null, 2);
                const blob = new Blob([dataContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create download link
                const a = document.createElement('a');
                a.href = url;
                a.download = `vinaris_data_${currentUser.name}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                EnhancedUI.showToast('მონაცემები წარმატებით გადმოიწერა', 'success');
                
            } catch (error) {
                console.error('Error downloading data:', error);
                EnhancedUI.showToast('მონაცემების გადმოწერა ვერ მოხერხდა: ' + error.message, 'error');
            } finally {
                EnhancedUI.hideLoading();
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'N/A';
                
                return date.toLocaleDateString('ka-GE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'N/A';
            }
        }

        function showProfileModal(content) {
            console.log('showProfileModal called with content length:', content ? content.length : 'null');
            const modal = document.getElementById('profileModal');
            const modalContent = document.getElementById('profileModalContent');
            
            console.log('Modal elements:', { modal: !!modal, modalContent: !!modalContent });
            
            if (modal && modalContent) {
                modalContent.innerHTML = content;
                modal.style.display = 'flex';
                console.log('Profile modal displayed');
                
                // Add click outside to close
                modal.onclick = function(event) {
                    if (event.target === modal) {
                        closeProfileModal();
                    }
                };
                
                // Add escape key to close
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && modal.style.display === 'flex') {
                        closeProfileModal();
                    }
                });
            }
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function showProfilePage(user, totalRequests, pendingRequests, completedRequests, accountAge, requests) {
            // Hide the main content sections but keep the header
            const sectionsToHide = [
                '.vin-section',
                '.metrics', 
                '.controls',
                '.table-container',
                '.card'
            ];
            
            sectionsToHide.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el.id !== 'profilePage') {
                        el.style.display = 'none';
                    }
                });
            });
            
            // Show profile page
            const profilePage = document.getElementById('profilePage');
            const profilePageContent = document.getElementById('profilePageContent');
            
            if (profilePage && profilePageContent) {
                // Create profile content
                const profileContent = createProfilePageContent(user, totalRequests, pendingRequests, completedRequests, accountAge, requests);
                profilePageContent.innerHTML = profileContent;
                profilePage.style.display = 'block';
            }
        }

        function hideProfilePage() {
            // Hide profile page
            const profilePage = document.getElementById('profilePage');
            if (profilePage) {
                profilePage.style.display = 'none';
            }
            
            // Show all the main content sections
            const sectionsToShow = [
                '.vin-section',
                '.metrics', 
                '.controls',
                '.table-container',
                '.card'
            ];
            
            sectionsToShow.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el.id !== 'profilePage') {
                        el.style.display = '';
                    }
                });
            });
        }

        function createProfilePageContent(user, totalRequests, pendingRequests, completedRequests, accountAge, requests) {
            return `
                <div class="profile-page-container">
                    <!-- Profile Header -->
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="profile-title">
                            <h2>${user.name}</h2>
                            <p class="profile-email">${user.email}</p>
                            <span class="profile-status active">აქტიური მომხმარებელი</span>
                        </div>
                    </div>

                    <!-- Profile Actions -->
                    <div class="profile-actions">
                        <button class="btn btn-primary" onclick="editProfile()">
                            <i class="fas fa-edit"></i> პროფილის რედაქტირება
                        </button>
                        <button class="btn btn-secondary" onclick="changePassword()">
                            <i class="fas fa-key"></i> პაროლის შეცვლა
                        </button>
                        <button class="btn btn-info" onclick="downloadData()">
                            <i class="fas fa-download"></i> მონაცემების გადმოწერა
                        </button>
                    </div>


                    <!-- Profile Information -->
                    <div class="profile-info-section">
                        <h3><i class="fas fa-info-circle"></i> ინფორმაცია</h3>
                        
                        <!-- Personal Information Group -->
                        <div class="info-group">
                            <h4 class="info-group-title">
                                <i class="fas fa-user"></i> პირადი ინფორმაცია
                            </h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>მომხმარებლის ID</label>
                                    <span class="info-value">${user.id || user.uniqueId || 'N/A'}</span>
                                </div>
                                <div class="info-item">
                                    <label>ელ. ფოსტა</label>
                                    <span class="info-value">${user.email}</span>
                                </div>
                                <div class="info-item">
                                    <label>სტატუსი</label>
                                    <span class="status-badge active">აქტიური</span>
                                </div>
                            </div>
                        </div>

                        <!-- Account Information Group -->
                        <div class="info-group">
                            <h4 class="info-group-title">
                                <i class="fas fa-clock"></i> ანგარიშის ინფორმაცია
                            </h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>რეგისტრაციის თარიღი</label>
                                    <span class="info-value">${formatDate(user.created_at || user.registrationDate)}</span>
                                </div>
                                <div class="info-item">
                                    <label>ანგარიშის ასაკი</label>
                                    <span class="info-value">${accountAge} დღე</span>
                                </div>
                                <div class="info-item">
                                    <label>ბოლო აქტივობა</label>
                                    <span class="info-value">${formatDate(user.last_login || user.updated_at)}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="profile-activity-section">
                        <h3><i class="fas fa-history"></i> ბოლო აქტივობა</h3>
                        <div class="activity-list">
                            ${requests.slice(0, 5).map(request => `
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-car"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">VIN შემოწმება: ${request.vin}</div>
                                        <div class="activity-meta">
                                            <span class="activity-status status-${request.status}">${getStatusText(request.status)}</span>
                                            <span class="activity-date">${formatDate(request.createdAt)}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${requests.length === 0 ? `
                                <div class="no-activity">
                                    <i class="fas fa-inbox"></i>
                                    <p>ჯერ არ არის აქტივობა</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <style>
                    .profile-page-container {
                        max-width: 900px;
                        margin: 0 auto;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    }

                    .profile-header {
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        padding: 20px;
                        background: linear-gradient(135deg, var(--primary), var(--accent));
                        color: white;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                    }

                    .profile-avatar {
                        width: 60px;
                        height: 60px;
                        background: rgba(255,255,255,0.2);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 30px;
                        backdrop-filter: blur(10px);
                    }

                    .profile-title h2 {
                        margin: 0 0 6px 0;
                        font-size: 22px;
                        font-weight: 600;
                    }

                    .profile-email {
                        margin: 0 0 6px 0;
                        opacity: 0.9;
                        font-size: 14px;
                    }

                    .profile-status {
                        background: rgba(255,255,255,0.2);
                        padding: 4px 10px;
                        border-radius: 15px;
                        font-size: 11px;
                        font-weight: 500;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }

                    .profile-actions {
                        display: flex;
                        gap: 10px;
                        margin-bottom: 20px;
                        flex-wrap: wrap;
                    }

                    .profile-actions .btn {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        padding: 8px 16px;
                        border: none;
                        border-radius: 6px;
                        font-size: 13px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        text-decoration: none;
                    }

                    .profile-actions .btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                    }


                    .profile-info-section, .profile-activity-section {
                        background: var(--panel2);
                        border-radius: 10px;
                        padding: 18px;
                        margin-bottom: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                    }

                    .profile-info-section h3, .profile-activity-section h3 {
                        margin: 0 0 15px 0;
                        color: var(--text);
                        font-size: 16px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }

                    .info-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                    }

                    .info-item {
                        display: flex;
                        flex-direction: column;
                        gap: 3px;
                    }

                    .info-item label {
                        font-size: 11px;
                        color: var(--muted);
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        font-weight: 500;
                    }

                    .info-value {
                        font-size: 13px;
                        color: var(--text);
                        font-weight: 500;
                    }

                    .status-badge {
                        display: inline-block;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 500;
                        text-transform: uppercase;
                    }

                    .status-badge.active {
                        background: rgba(40, 167, 69, 0.2);
                        color: #28a745;
                    }

                    .activity-list {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }

                    .activity-item {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        background: var(--panel);
                        border-radius: 6px;
                        border: 1px solid var(--border);
                    }

                    .activity-icon {
                        width: 32px;
                        height: 32px;
                        background: var(--accent);
                        border-radius: 6px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 14px;
                    }

                    .activity-content {
                        flex: 1;
                    }

                    .activity-title {
                        font-size: 13px;
                        font-weight: 500;
                        color: var(--text);
                        margin-bottom: 3px;
                    }

                    .activity-meta {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-size: 11px;
                    }

                    .activity-status {
                        padding: 2px 5px;
                        border-radius: 3px;
                        font-weight: 500;
                    }

                    .activity-date {
                        color: var(--muted);
                    }

                    .no-activity {
                        text-align: center;
                        padding: 30px;
                        color: var(--muted);
                    }

                    .no-activity i {
                        font-size: 36px;
                        margin-bottom: 10px;
                        opacity: 0.5;
                    }

                    @media (max-width: 768px) {
                        .profile-page-container {
                            padding: 0 10px;
                        }
                        
                        .profile-header {
                            flex-direction: column;
                            text-align: center;
                            padding: 15px;
                            gap: 10px;
                        }
                        
                        .profile-avatar {
                            width: 50px;
                            height: 50px;
                            font-size: 24px;
                        }
                        
                        .profile-title h2 {
                            font-size: 18px;
                        }
                        
                        .profile-email {
                            font-size: 13px;
                        }
                        
                        .profile-actions {
                            justify-content: center;
                            gap: 8px;
                        }
                        
                        .profile-actions .btn {
                            padding: 6px 12px;
                            font-size: 12px;
                        }
                        
                        
                        .info-grid {
                            grid-template-columns: 1fr;
                            gap: 10px;
                        }
                        
                        .profile-info-section, .profile-activity-section {
                            padding: 15px;
                        }
                        
                        .activity-item {
                            padding: 10px;
                            gap: 10px;
                        }
                        
                        .activity-icon {
                            width: 28px;
                            height: 28px;
                            font-size: 12px;
                        }
                        
                        .activity-title {
                            font-size: 12px;
                        }
                        
                        .activity-meta {
                            font-size: 10px;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        
                        .profile-actions {
                            flex-direction: column;
                            align-items: stretch;
                        }
                        
                        .profile-actions .btn {
                            justify-content: center;
                        }
                    }
                </style>
            `;
        }

        async function handleLogout() {
            try {
                await EnhancedAuth.logout();
                window.location.href = '../Login/login.html';
            } catch (error) {
                console.error('Logout error:', error);
                // Force logout even if API fails
                TokenManager.clearToken();
                window.location.href = '../Login/login.html';
            }
        }

        function getStatusLabel(status) {
            const labels = {
                pending: 'მუშავდება',
                completed: 'დამუშავებულია',
                processed: 'დამუშავებულია',
                delivered: 'დამუშავებულია',
                rejected: 'უარყოფილი'
            };
            return labels[status] || status;
        }

        function startPeriodicUpdates() {
            // Refresh data every 30 seconds
            setInterval(async () => {
                try {
                    const profileData = await UserManager.getProfile();
                    currentUser = profileData.user;
                    TokenManager.setCurrentUser(currentUser);
                    updateMetrics();
                } catch (error) {
                    console.log('Background update failed:', error);
                }
            }, 30000);
        }
    </script>
</body>
</html>
